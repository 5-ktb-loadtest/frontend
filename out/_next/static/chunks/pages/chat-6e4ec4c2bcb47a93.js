(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[180],{17722:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return t(75417)}])},75417:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>eg});var n=t(85893),o=t(67294),s=t(83707),l=t(63171),a=t(74341),i=t(31530),c=t(1539),u=t(2026),d=t(74303),m=t(4987),g=t(22226),h=t(83867),f=t(11163),p=t(19182),v=t(37804),y=t(78536),x=t(86727);let j=(e,r,t,n)=>{let[s,l]=(0,o.useState)(null),[a,i]=(0,o.useState)(!1),[c,u]=(0,o.useState)(0),[d,m]=(0,o.useState)(null),g=(0,o.useRef)(null),h=(0,o.useCallback)(async function(o){var s,a,c,d,g;let h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(null===(s=e.current)||void 0===s?void 0:s.connected)||!r){y.F.error("채팅 서버와 연결이 끊어졌습니다.");return}let f=null==t?void 0:null===(a=t.query)||void 0===a?void 0:a.room;if(!f){y.F.error("채팅방 정보를 찾을 수 없습니다.");return}try{i(!0),m(null),u(0);let r=await x.Z.uploadFile(o,e=>u(e));if(!r.success)throw Error(r.message||"파일 업로드에 실패했습니다.");await e.current.emit("chatMessage",{room:f,type:"file",content:h,fileData:{_id:r.data.file._id,filename:r.data.file.filename,originalname:r.data.file.originalname,mimetype:r.data.file.mimetype,size:r.data.file.size}}),l(null),i(!1),u(0)}catch(e){if(console.error("File upload error:",e),(null===(c=e.message)||void 0===c?void 0:c.includes("세션"))||(null===(d=e.message)||void 0===d?void 0:d.includes("인증"))||(null===(g=e.message)||void 0===g?void 0:g.includes("토큰"))){await n();return}m(e.message||"파일 업로드에 실패했습니다."),y.F.error(e.message||"파일 업로드에 실패했습니다.")}finally{i(!1)}},[e,r,t,n]),f=(0,o.useCallback)(async e=>{try{let r=await x.Z.validateFile(e);if(!r.success)throw Error(r.message);let t={file:e,url:URL.createObjectURL(e),name:e.name,type:e.type,size:e.size};l(t),m(null)}catch(e){console.error("File selection error:",e),y.F.error(e.message||"파일 선택 중 오류가 발생했습니다."),g.current&&(g.current.value="")}},[]),p=(0,o.useCallback)(async e=>{e.preventDefault(),e.stopPropagation();let r=Array.from(e.dataTransfer.files);if(0!==r.length)try{await f(r[0])}catch(e){console.error("File drop error:",e),y.F.error(e.message||"파일 드롭 중 오류가 발생했습니다.")}},[f]),v=(0,o.useCallback)(()=>{(null==s?void 0:s.url)&&URL.revokeObjectURL(s.url),l(null),m(null),u(0),g.current&&(g.current.value="")},[s]),j=(0,o.useCallback)(async e=>{var r;let t=null===(r=e.clipboardData)||void 0===r?void 0:r.items;if(!t)return;let n=Array.from(t).find(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(!n)return;let o=n.getAsFile();if(o)try{await f(o),e.preventDefault()}catch(e){console.error("File paste error:",e),y.F.error(e.message||"파일 붙여넣기 중 오류가 발생했습니다.")}},[f]);return(0,o.useEffect)(()=>()=>{(null==s?void 0:s.url)&&URL.revokeObjectURL(s.url)},[s]),{filePreview:s,uploading:a,uploadProgress:c,uploadError:d,fileInputRef:g,setFilePreview:l,setUploading:i,setUploadProgress:u,setUploadError:m,handleFileUpload:h,handleFileSelect:f,handleFileDrop:p,handlePaste:j,removeFilePreview:v}},b=function(e,r,t,n){var s;let l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],[a,i]=(0,o.useState)(""),[c,u]=(0,o.useState)(!1),[d,m]=(0,o.useState)(!1),[g,h]=(0,o.useState)(""),[f,p]=(0,o.useState)(0),[v,j]=(0,o.useState)(null),[b,w]=(0,o.useState)(!1),[k,R]=(0,o.useState)(0),[N,C]=(0,o.useState)(null),[S,E]=(0,o.useState)(!1),I=(0,o.useCallback)(e=>{let r;if("string"==typeof e)r=e;else if(e&&"object"==typeof e&&e.target){var t;r=null!==(t=e.target.value)&&void 0!==t?t:""}else{console.warn("handleMessageChange: Invalid parameter type",typeof e,e);return}i(r);let n=r.split("\n"),o=n[n.length-1],s=o.lastIndexOf("@");if(-1!==s){let e=o.slice(s+1);if(!e.includes(" ")){h(e.toLowerCase()),m(!0),p(0);return}}m(!1)},[]),L=(0,o.useCallback)(async()=>{var r,n,o;if(!(null===(r=e.current)||void 0===r?void 0:r.connected)){console.warn("Cannot load messages: Socket not connected");return}try{if(S){console.log("Already loading messages, skipping...");return}E(!0);let r=null===(n=l[0])||void 0===n?void 0:n.timestamp;return console.log("Loading more messages:",{roomId:null==t?void 0:null===(o=t.query)||void 0===o?void 0:o.room,before:r,currentMessageCount:l.length}),new Promise((n,o)=>{var s;let l=setTimeout(()=>{E(!1),o(Error("Message loading timed out"))},1e4);e.current.emit("fetchPreviousMessages",{roomId:null==t?void 0:null===(s=t.query)||void 0===s?void 0:s.room,before:r}),e.current.once("previousMessagesLoaded",e=>{clearTimeout(l),E(!1),n(e)}),e.current.once("error",e=>{clearTimeout(l),E(!1),o(e)})})}catch(e){throw console.error("Load more messages error:",e),y.F.error("이전 메시지를 불러오는데 실패했습니다."),E(!1),e}},[e,null==t?void 0:null===(s=t.query)||void 0===s?void 0:s.room,S,l]),T=(0,o.useCallback)(async o=>{var s,l,a,c,d,g,h,f,p,v,b;if(!(null===(s=e.current)||void 0===s?void 0:s.connected)||!r){console.error("[Chat] Cannot send message: Socket not connected"),y.F.error("채팅 서버와 연결이 끊어졌습니다.");return}let k=null==t?void 0:null===(l=t.query)||void 0===l?void 0:l.room;if(!k){y.F.error("채팅방 정보를 찾을 수 없습니다.");return}try{if(console.log("[Chat] Sending message:",o),"file"===o.type){let r;w(!0),C(null),R(0);let t=await x.Z.uploadChatFile(o.fileData.file,k,e=>R(e));if(console.log("[Chat] File upload response:",t),null===(c=t.data)||void 0===c?void 0:c.file)r={_id:t.data.file._id,filename:t.data.file.filename,originalname:t.data.file.originalname,mimetype:t.data.file.mimetype,size:t.data.file.size,url:t.data.file.url,path:t.data.file.path};else{let e=(null===(d=t.url)||void 0===d?void 0:d.split("/").pop())||"unknown";r={_id:(()=>{let e=Math.floor(Date.now()/1e3).toString(16).padStart(8,"0"),r=Array.from({length:16},()=>Math.floor(16*Math.random()).toString(16)).join("");return e+r})(),filename:e,originalname:t.originalName||o.fileData.name||e,mimetype:t.type||o.fileData.type||"application/octet-stream",size:t.size||o.fileData.size||0,url:t.url,path:t.url,key:t.key,bucket:"ktb-stress-test-5",uploadedAt:t.uploadedAt||new Date().toISOString(),isS3File:!0,s3Key:t.key||"chat-files/".concat(k,"/").concat(e)}}console.log("[Chat] Processed file data:",r),e.current.emit("chatMessage",{room:k,type:"file",content:o.content||"",fileData:{...r,isS3File:!0,s3Uploaded:!0,skipFileValidation:!0,alreadyUploaded:!0}}),j(null),i(""),w(!1),R(0),y.F.success("파일이 성공적으로 업로드되었습니다.")}else(null===(a=o.content)||void 0===a?void 0:a.trim())&&(e.current.emit("chatMessage",{room:k,type:"text",content:o.content.trim()}),i(""));u(!1),m(!1)}catch(r){if(console.error("[Chat] Message submit error:",r),"file"===o.type&&(null===(g=uploadResponse)||void 0===g?void 0:g.url)&&(console.warn("[Chat] File uploaded to S3 but message failed:",{s3Url:uploadResponse.url,error:r.message}),y.F.error("파일은 업로드되었지만 메시지 전송에 실패했습니다. 다시 시도해주세요."),console.log("S3 파일 URL:",uploadResponse.url)),(null===(h=r.message)||void 0===h?void 0:h.includes("세션"))||(null===(f=r.message)||void 0===f?void 0:f.includes("인증"))||(null===(p=r.message)||void 0===p?void 0:p.includes("토큰"))){await n();return}let e="메시지 전송 중 오류가 발생했습니다.";(null===(v=r.message)||void 0===v?void 0:v.includes("파일을 찾을 수 없거나"))?e="S3 파일 처리 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.":(null===(b=r.message)||void 0===b?void 0:b.includes("권한"))&&(e="파일 접근 권한이 없습니다. 관리자에게 문의하세요."),y.F.error(e),"file"===o.type&&(C(e),w(!1),R(0))}},[r,t,n,e]),M=(0,o.useCallback)(()=>{u(e=>!e)},[]),A=(0,o.useCallback)(e=>(null==e?void 0:e.participants)?[{_id:"wayneAI",name:"wayneAI",email:"ai@wayne.ai",isAI:!0},{_id:"consultingAI",name:"consultingAI",email:"ai@consulting.ai",isAI:!0},...e.participants].filter(e=>e.name.toLowerCase().includes(g)||e.email.toLowerCase().includes(g)):[],[g]),F=(0,o.useCallback)((e,r)=>{if(!(null==e?void 0:e.current))return;let t=e.current.selectionStart,n=a.slice(0,t).lastIndexOf("@");-1!==n&&(i(a.slice(0,n)+"@".concat(r.name," ")+a.slice(t)),m(!1),setTimeout(()=>{let t=n+r.name.length+2;e.current.focus(),e.current.setSelectionRange(t,t)},0))},[a]),D=(0,o.useCallback)(()=>{j(null),C(null),R(0)},[]);return{message:a,showEmojiPicker:c,showMentionList:d,mentionFilter:g,mentionIndex:f,filePreview:v,uploading:b,uploadProgress:k,uploadError:N,loadingMessages:S,setMessage:i,setShowEmojiPicker:u,setShowMentionList:m,setMentionFilter:h,setMentionIndex:p,setFilePreview:j,setLoadingMessages:E,handleMessageChange:I,handleMessageSubmit:T,handleEmojiToggle:M,handleLoadMore:L,getFilteredParticipants:A,insertMention:F,removeFilePreview:D}},w=(e,r,t,n)=>{let[s]=(0,o.useState)(new Map);return{handleReactionAdd:(0,o.useCallback)(async(o,s)=>{try{var l;if(!(null===(l=e.current)||void 0===l?void 0:l.connected))throw Error("Socket not connected");n(e=>e.map(e=>{if(e._id===o){let t=e.reactions||{},n=t[s]||[];if(!n.includes(r.id))return{...e,reactions:{...t,[s]:[...n,r.id]}}}return e})),await e.current.emit("messageReaction",{messageId:o,reaction:s,type:"add"})}catch(e){console.error("Add reaction error:",e),y.F.error("리액션 추가에 실패했습니다."),n(e=>e.map(e=>{var r;return e._id===o?{...e,reactions:(null===(r=t.find(e=>e._id===o))||void 0===r?void 0:r.reactions)||{}}:e}))}},[e,r,t,n]),handleReactionRemove:(0,o.useCallback)(async(o,s)=>{try{var l;if(!(null===(l=e.current)||void 0===l?void 0:l.connected))throw Error("Socket not connected");n(e=>e.map(e=>{if(e._id===o){let t=e.reactions||{},n=t[s]||[];return{...e,reactions:{...t,[s]:n.filter(e=>e!==r.id)}}}return e})),await e.current.emit("messageReaction",{messageId:o,reaction:s,type:"remove"})}catch(e){console.error("Remove reaction error:",e),y.F.error("리액션 제거에 실패했습니다."),n(e=>e.map(e=>{var r;return e._id===o?{...e,reactions:(null===(r=t.find(e=>e._id===o))||void 0===r?void 0:r.reactions)||{}}:e}))}},[e,r,t,n]),handleReactionUpdate:(0,o.useCallback)(e=>{let{messageId:r,reactions:t}=e;n(e=>e.map(e=>e._id===r?{...e,reactions:t}:e))},[n])}},k=(e,r,t,n)=>{let[s,l]=(0,o.useState)({}),a=(0,o.useCallback)(e=>{console.log("AI message stream started:",e.messageId),l(r=>({...r,[e.messageId]:{_id:e.messageId,type:"ai",aiType:e.aiType,content:"",timestamp:new Date(e.timestamp),isStreaming:!0}})),n()},[n]),i=(0,o.useCallback)(e=>{var r;if(!e.messageId){console.warn("Received AI message chunk without messageId");return}console.log("AI message chunk received:",{messageId:e.messageId,chunkLength:null===(r=e.fullContent)||void 0===r?void 0:r.length,isCodeBlock:e.isCodeBlock}),l(r=>r[e.messageId]?{...r,[e.messageId]:{...r[e.messageId],content:e.fullContent,isCodeBlock:e.isCodeBlock}}:(console.warn("No existing streaming message for chunk:",e.messageId),r)),t&&n()},[t,n]),c=(0,o.useCallback)(e=>{console.log("AI message stream completed:",e.messageId),l(r=>{let{[e.messageId]:t,...n}=r;return n}),r(r=>[...r,{_id:e._id,type:"ai",aiType:e.aiType,content:e.content,timestamp:new Date(e.timestamp),isComplete:!0}]),n()},[r,n]),u=(0,o.useCallback)(e=>{console.error("AI message error:",e),l(r=>{let{[e.messageId]:t,...n}=r;return n}),y.F.error("AI 응답 오류: ".concat(e.error))},[]),d=(0,o.useCallback)(()=>{if(!e.current){console.warn("Cannot setup AI message listeners: socket not initialized");return}let r=e.current;return r.off("aiMessageStart").off("aiMessageChunk").off("aiMessageComplete").off("aiMessageError"),r.on("aiMessageStart",a),r.on("aiMessageChunk",i),r.on("aiMessageComplete",c),r.on("aiMessageError",u),()=>{r.off("aiMessageStart").off("aiMessageChunk").off("aiMessageComplete").off("aiMessageError")}},[e,a,i,c,u]);return{streamingMessages:s,setStreamingMessages:l,handleAIMessageStart:a,handleAIMessageChunk:i,handleAIMessageComplete:c,handleAIMessageError:u,setupAIMessageListeners:d,sendAIMessage:(0,o.useCallback)(async(r,t)=>{var n;if(!(null===(n=e.current)||void 0===n?void 0:n.connected))throw Error("Socket not connected");try{console.log("Sending AI message:",{aiType:r,content:t}),e.current.emit("chatMessage",{type:"ai",aiType:r,content:t.trim()})}catch(e){throw console.error("Send AI message error:",e),y.F.error("AI 메시지 전송에 실패했습니다."),e}},[e])}},R=function(e,r){var t;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],[s,l]=(0,o.useState)(!0),[a,i]=(0,o.useState)(!0),[c,u]=(0,o.useState)(!1),[d,m]=(0,o.useState)(!1),[g,h]=(0,o.useState)(!1),f=(0,o.useRef)(null),p=(0,o.useRef)(0),v=(0,o.useRef)(0),y=(0,o.useRef)(0),x=(0,o.useRef)(!1),j=(0,o.useRef)((null==n?void 0:n.length)||0),b=(0,o.useRef)(null),w=(0,o.useRef)(null),k=(0,o.useRef)(null),R=(0,o.useRef)(!1),N=(0,o.useCallback)((e,r)=>{console.debug("[ScrollHandling] ".concat(e,":"),{...r,timestamp:new Date().toISOString()})},[]),C=(0,o.useCallback)(()=>{if(!f.current)return{isAtBottom:!0,isAtTop:!1};let{scrollTop:e,scrollHeight:r,clientHeight:t}=f.current;return{isAtBottom:r-(e+t)<100,isAtTop:e<30,scrollTop:e,scrollHeight:r,clientHeight:t}},[]),S=(0,o.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";!g&&f.current&&requestAnimationFrame(()=>{try{let r=f.current;if(!r)return;let{scrollHeight:t,clientHeight:n}=r,o=t-n;r.scrollTo({top:o,behavior:"auto"===e?"auto":"smooth"}),N("scrollToBottom",{scrollHeight:t,clientHeight:n,maxScrollTop:o,behavior:e,isLoadingPrevious:g})}catch(e){console.error("Scroll error:",e)}})},[g,N]),E=(0,o.useCallback)(async()=>{if(!a||c||x.current||R.current){N("loadMore prevented",{hasMoreMessages:a,loadingMessages:c,isLoading:x.current,loadMoreTriggered:R.current});return}try{var t;if(!(null==e?void 0:null===(t=e.current)||void 0===t?void 0:t.connected))throw Error("Socket not connected");let o=f.current;if(!o)return;h(!0),x.current=!0,R.current=!0,p.current=o.scrollHeight,v.current=o.scrollTop,y.current=o.scrollTop,u(!0);let s=null==n?void 0:n[0];if(!s){i(!1),x.current=!1,R.current=!1,u(!1),h(!1);return}let l=new Promise((t,n)=>{var o;e.current.emit("fetchPreviousMessages",{roomId:null==r?void 0:null===(o=r.query)||void 0===o?void 0:o.room,before:s.timestamp}),e.current.once("previousMessagesLoaded",e=>{t(e)}),e.current.once("error",e=>{h(!1),n(e)}),setTimeout(()=>{h(!1),n(Error("Timeout loading messages"))},1e4)});await l}catch(e){console.error("Load more error:",e),h(!1),x.current=!1,R.current=!1,u(!1)}},[a,c,n,e,null==r?void 0:null===(t=r.query)||void 0===t?void 0:t.room,u]),I=(0,o.useCallback)(()=>{if(console.log("Scroll event triggered"),!f.current){console.log("No messagesEndRef");return}b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{console.log("Scroll timeout triggered");let e=f.current;if(!e){console.log("No container in timeout");return}let{scrollTop:r,scrollHeight:t,clientHeight:n}=e,o=t-(r+n)<100,s=r<30;console.log("Scroll position:",{scrollTop:r,scrollHeight:t,clientHeight:n,isAtTop:s,isAtBottom:o}),l(o),!s||(console.log("Is at top, checking conditions:",{hasMoreMessages:a,loadingMessages:c,isLoading:x.current,loadMoreTriggered:R.current}),!a||c||x.current||R.current||(console.log("Calling tryLoadMoreMessages"),E()))},150)},[a,c,E,N]);return(0,o.useEffect)(()=>{let e=(null==n?void 0:n.length)||0;e>j.current&&!g&&(s&&S(),j.current=e)},[n,s,S,g]),(0,o.useEffect)(()=>{d||!((null==n?void 0:n.length)>0)||g||(S("auto"),m(!0),N("initialScroll"))},[null==n?void 0:n.length,d,S,g,N]),(0,o.useEffect)(()=>{!c&&p.current>0&&(k.current&&cancelAnimationFrame(k.current),k.current=requestAnimationFrame(()=>{try{let e=f.current;if(!e)return;let r=e.scrollHeight,t=r-p.current,n=v.current+t;if(N("scroll restoration",{previousHeight:p.current,newHeight:r,heightDiff:t,previousScrollTop:v.current,newScrollTop:n,isLoadingPrevious:g}),g){let r=e.style.scrollBehavior;e.style.scrollBehavior="auto",e.scrollTop=n,requestAnimationFrame(()=>{e.style.scrollBehavior=r})}p.current=0,v.current=0,y.current=n,x.current=!1,R.current=!1,setTimeout(()=>{h(!1)},100)}catch(e){console.error("Scroll restoration error:",e),x.current=!1,R.current=!1,h(!1)}}))},[c,N]),(0,o.useEffect)(()=>()=>{b.current&&clearTimeout(b.current),w.current&&clearTimeout(w.current),k.current&&cancelAnimationFrame(k.current),x.current=!1,R.current=!1,h(!1)},[]),{isNearBottom:s,hasMoreMessages:a,loadingMessages:c,initialScrollDone:d,messagesEndRef:f,scrollToBottom:S,handleScroll:I,tryLoadMoreMessages:E,checkScrollPosition:C,setHasMoreMessages:i,setLoadingMessages:u,setInitialScrollDone:m,setIsNearBottom:l,isLoadingPreviousMessages:g}},N=function(e){var r,t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,[s,l]=(0,o.useState)(!1),[a,i]=(0,o.useState)(null),[c,u]=(0,o.useState)(0),[d,m]=(0,o.useState)(!1),g=(0,o.useRef)(null),h=(0,o.useRef)(null),f=(0,o.useRef)(null),p=(0,o.useRef)(null),x=(0,o.useCallback)(()=>{h.current&&clearTimeout(h.current),f.current&&clearInterval(f.current),p.current&&clearTimeout(p.current)},[]),j=(0,o.useCallback)(e=>Math.min(1e3*Math.pow(2,e),1e4),[]),b=(0,o.useCallback)(async(r,t)=>{console.error("Connection error:",r),l(!1),m(!0);try{var o,s,a;if((null==r?void 0:null===(o=r.message)||void 0===o?void 0:o.includes("세션"))||(null==r?void 0:null===(s=r.message)||void 0===s?void 0:s.includes("인증"))||(null==r?void 0:null===(a=r.message)||void 0===a?void 0:a.includes("토큰"))){await (null==t?void 0:t());return}if(c<n){let r=j(c);console.log("Retrying connection in ".concat(r,"ms... (Attempt ").concat(c+1,"/").concat(n,")")),x(),h.current=setTimeout(async()=>{try{if(g.current){var r;await g.current.connect(),l(!0),m(!1),u(0),i(null),(null==e?void 0:null===(r=e.query)||void 0===r?void 0:r.room)&&g.current.emit("joinRoom",e.query.room)}}catch(e){console.error("Retry connection failed:",e),u(e=>e+1),b(e,t)}},r)}else m(!1),y.F.error("채팅 서버와 연결할 수 없습니다. 페이지를 새로고침해주세요.")}catch(e){console.error("Error handling connection error:",e),m(!1)}},[c,n,x,j,null==e?void 0:null===(r=e.query)||void 0===r?void 0:r.room]),w=(0,o.useCallback)(async(r,t)=>{if(!d)try{if(!(null==r?void 0:r.token)||!(null==r?void 0:r.sessionId))throw Error("Invalid user credentials");i(null),u(0),m(!0),x(),g.current&&(g.current.disconnect(),l(!1));let o=await v.Z.connect({auth:{token:r.token,sessionId:r.sessionId},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:n,reconnectionDelay:j(0),reconnectionDelayMax:1e4,timeout:2e4});g.current=o,p.current=setTimeout(()=>{o.connected||b(Error("Connection timeout"),t)},2e4),o.on("connect",()=>{var r;l(!0),m(!1),x(),(null==e?void 0:null===(r=e.query)||void 0===r?void 0:r.room)&&o.emit("joinRoom",e.query.room)}),o.on("connect_error",e=>{b(e,t)}),o.on("disconnect",e=>{console.log("Socket disconnected:",e),l(!1),"io server disconnect"!==e&&"io client disconnect"!==e&&b(Error("Disconnected: ".concat(e)),t)})}catch(e){var o,s,a;if(console.error("Reconnection failed:",e),l(!1),m(!1),(null===(o=e.message)||void 0===o?void 0:o.includes("세션"))||(null===(s=e.message)||void 0===s?void 0:s.includes("인증"))||(null===(a=e.message)||void 0===a?void 0:a.includes("토큰"))){await (null==t?void 0:t());return}y.F.error("재연결에 실패했습니다.")}},[d,x,j,n,null==e?void 0:null===(t=e.query)||void 0===t?void 0:t.room,b]);return(0,o.useEffect)(()=>x,[x]),(0,o.useEffect)(()=>{let e=g.current;if(!e)return;let r=()=>{console.log("Socket connected"),l(!0),m(!1),u(0),i(null)},t=()=>{console.log("Socket disconnected"),l(!1)};return e.on("connect",r),e.on("disconnect",t),l(e.connected),()=>{e.off("connect",r),e.off("disconnect",t)}},[g.current]),(0,o.useEffect)(()=>{let e=()=>{console.log("Network is online"),s||d||w()},r=()=>{console.log("Network is offline"),l(!1)};return window.addEventListener("online",e),window.addEventListener("offline",r),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",r)}},[s,d,w]),{connected:s,error:a,socketRef:g,isReconnecting:d,setConnected:l,setError:i,handleConnectionError:b,handleReconnect:w,cleanup:x}},C=(e,r,t,n,s,l,a,i,c,u,d,m,g,h,f,y,x,j)=>{let b=(0,o.useRef)(null),w=(0,o.useRef)(null),k=(0,o.useRef)(null),R=(0,o.useRef)(null),N=(0,o.useRef)(0),C=(0,o.useRef)(0),S=(0,o.useCallback)(()=>{w.current&&(clearTimeout(w.current),w.current=null),k.current&&(clearTimeout(k.current),k.current=null),R.current&&(clearTimeout(R.current),R.current=null)},[]),E=async()=>{try{if(!p.Z.getCurrentUser())throw Error("No user session found");if(await p.Z.refreshToken()&&t.current)return!0}catch(e){console.error("Token refresh failed:",e)}return t.current&&(await p.Z.logout(),n.replace("/?redirect="+n.asPath)),!1},I=(0,o.useCallback)(async()=>{try{var r;let t=p.Z.getCurrentUser();if(!(null==t?void 0:t.token)||!(null==t?void 0:t.sessionId))throw Error("Invalid authentication state");if(null===(r=e.current)||void 0===r?void 0:r.connected)return console.log("Reusing existing socket connection"),e.current;if(e.current){console.log("Cleaning up existing socket");let r=e.current;(null==x?void 0:x.get(r.id))&&(await new Promise(e=>{r.emit("leaveRoom",x.get(r.id)),setTimeout(e,1e3)}),x.delete(r.id)),r.disconnect(),r.removeAllListeners(),e.current=null,await new Promise(e=>setTimeout(e,2e3))}let n=await v.Z.connect({auth:{token:t.token,sessionId:t.sessionId},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:3e4,pingTimeout:12e4,pingInterval:6e4,forceNew:!0,autoConnect:!0});return new Promise((e,r)=>{let t=!1,o=setTimeout(()=>{t||(m(),r(Error("Socket connection timeout")))},3e4),s=()=>{t||(t=!0,clearTimeout(o),n.removeListener("connect_error",l),n.removeListener("error",l),N.current=0,e(n))},l=e=>{t||(t=!0,clearTimeout(o),console.error("Socket connection error:",e),r(e))};if(n.connected){s();return}n.once("connect",s),n.once("connect_error",l),n.once("error",l)})}catch(e){throw console.error("Socket setup error:",e),"Invalid authentication state"===e.message&&n.replace("/?error=auth_required"),e}},[x,m,n]),L=(0,o.useCallback)(async e=>{try{let r=p.Z.getCurrentUser();if(!(null==r?void 0:r.token)||!(null==r?void 0:r.sessionId))throw await E(),Error("인증 정보가 유효하지 않습니다.");if(!e||!t.current)throw Error("채팅방 정보가 올바르지 않습니다.");let n=await fetch("".concat("http://34.64.60.60:5000/","/api/rooms/").concat(e),{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","x-auth-token":r.token,"x-session-id":r.sessionId},credentials:"include"});if(!n.ok){if(401===n.status){if(await E()&&t.current)return L(e);throw Error("인증이 만료되었습니다.")}throw Error("채팅방 정보를 불러오는데 실패했습니다.")}let o=await n.json();if(!o.success||!o.data)throw Error("채팅방 데이터가 올바르지 않습니다.");return o.data}catch(e){throw console.error("Fetch room data error:",e),e}},[t,E]),T=(0,o.useCallback)(async r=>{if(!r||!t.current)throw Error("잘못된 채팅방 정보입니다.");let n=e.current;if(!(null==n?void 0:n.connected))throw Error("Socket not connected");return new Promise((e,t)=>{let o=setTimeout(()=>{t(Error("채팅방 입장 시간이 초과되었습니다."))},2e4),s=t=>{clearTimeout(o),null==x||x.set(n.id,r),n.off("joinRoomError",l),n.off("error",l),e(t)},l=e=>{clearTimeout(o),n.off("joinRoomSuccess",s),n.off("error",l),t(e)};n.once("joinRoomSuccess",s),n.once("joinRoomError",l),n.once("error",l),n.emit("joinRoom",r)})},[e,t,x]),M=(0,o.useCallback)(async r=>{let t=async function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((o,s)=>{var l;let a;if(!(null===(l=e.current)||void 0===l?void 0:l.connected)){s(Error("Socket not connected"));return}let i=()=>{var r,t;a&&clearTimeout(a),null===(r=e.current)||void 0===r||r.off("previousMessagesLoaded",c),null===(t=e.current)||void 0===t||t.off("error",u)},c=e=>{if(i(),!e||!Array.isArray(e.messages)){n<3?(console.log("Invalid message format, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{t(n+1).then(o).catch(s)},2e3)):s(Error("잘못된 메시지 응답 형식입니다."));return}j(e.messages,e.hasMore,!0),o(e)},u=e=>{i(),n<3?(console.log("Message loading failed, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{t(n+1).then(o).catch(s)},2e3)):s(e)};e.current.once("previousMessagesLoaded",c),e.current.once("error",u),a=setTimeout(()=>{i(),n<3?(console.log("Message loading timed out, retrying (".concat(n+1,"/").concat(3,")...")),setTimeout(()=>{t(n+1).then(o).catch(s)},2e3)):s(Error("메시지 로딩 시간이 초과되었습니다."))},3e4),e.current.emit("fetchPreviousMessages",{roomId:r,limit:30})})};try{return await t()}catch(r){var n;if(!(null===(n=e.current)||void 0===n?void 0:n.connected))return console.log("Socket disconnected, attempting to reconnect..."),await I(),t();throw r}},[e,j,I]),A=(0,o.useCallback)(async()=>(b.current||(b.current=(async()=>{try{var o;f.current=!0,u(!0),l(null),C.current=0,console.log("Setting up socket connection..."),e.current=await I(),console.log("Fetching room data...");let a=await L(n.query.room);r&&a.participants&&!a.participants.some(e=>e._id===r.id||e.id===r.id)&&(a.participants=[...a.participants,{_id:r.id,id:r.id,name:r.name,email:r.email}]),s(a),console.log("Setting up event listeners..."),t.current&&d(),t.current&&(null===(o=e.current)||void 0===o?void 0:o.connected)&&(console.log("Joining room..."),await T(n.query.room),console.log("Loading initial messages..."),await M(n.query.room)),t.current&&(y.current=!0,h(!0)),console.log("Room setup completed successfully")}catch(r){throw console.error("Room setup error:",r),t.current&&(l(r.message.includes("시간 초과")?"채팅방 연결 시간이 초과되었습니다.":r.message||"채팅방 연결에 실패했습니다."),m(),e.current&&(e.current.disconnect(),e.current=null)),r}finally{t.current&&(u(!1),f.current=!1),S(),b.current=null}})()),b.current),[n,e,t,I,L,T,M,m,d,l,s,u,h,f,y,S]);return(0,o.useEffect)(()=>()=>{S(),b.current=null,f.current=!1,y.current=!1,N.current=0,C.current=0,e.current&&(console.log("Cleaning up socket connection"),e.current.disconnect(),e.current=null)},[S]),(0,o.useEffect)(()=>{let e=()=>{!y.current&&t.current&&(console.log("Network is back online, attempting to reconnect..."),A().catch(e=>{console.error("Auto reconnect failed:",e)}))};return window.addEventListener("online",e),()=>{window.removeEventListener("online",e)}},[A]),{setupRoom:A,joinRoom:T,loadInitialMessages:M,fetchRoomData:L,handleSessionError:E}},S={UNMOUNT:"unmount"},E=()=>{var e;let r=(0,f.useRouter)(),[t,n]=(0,o.useState)(null),[s,l]=(0,o.useState)([]),[a,i]=(0,o.useState)(null),[c,u]=(0,o.useState)(""),[d,m]=(0,o.useState)(!0),[g,h]=(0,o.useState)("checking"),[v,x]=(0,o.useState)(null),[E,I]=(0,o.useState)(!1),L=(0,o.useRef)(null),T=(0,o.useRef)(0),M=(0,o.useRef)(!0),A=(0,o.useRef)(!1),F=(0,o.useRef)(!1),D=(0,o.useRef)(!1),U=(0,o.useRef)(!1);(0,o.useRef)(0);let z=(0,o.useRef)(new Map),_=(0,o.useRef)(new Set),P=(0,o.useRef)(!1),B=(0,o.useRef)(!1);(0,o.useRef)(0);let O=(0,o.useRef)(new Set),q=(0,o.useRef)(null);(0,o.useRef)(0),(0,o.useRef)(!1),(0,o.useRef)(!1);let{connected:Z,socketRef:W,handleConnectionError:H,handleReconnect:K,setConnected:V}=N(r),{isNearBottom:X,hasMoreMessages:$,loadingMessages:J,messagesEndRef:Y,scrollToBottom:G,handleScroll:Q,setHasMoreMessages:ee,setLoadingMessages:er}=R(W,r,s),{streamingMessages:et,setStreamingMessages:en,handleAIMessageStart:eo,handleAIMessageChunk:es,handleAIMessageComplete:el,handleAIMessageError:ea,setupAIMessageListeners:ei}=k(W,l,X,G),{message:ec,showEmojiPicker:eu,showMentionList:ed,mentionFilter:em,mentionIndex:eg,filePreview:eh,uploading:ef,uploadProgress:ep,uploadError:ev,setMessage:ey,setShowEmojiPicker:ex,setShowMentionList:ej,setMentionFilter:eb,setMentionIndex:ew,setFilePreview:ek,handleMessageChange:eR,handleMessageSubmit:eN,handleLoadMore:eC,handleEmojiToggle:eS,getFilteredParticipants:eE,insertMention:eI,removeFilePreview:eL}=b(W,a,r),eT=(0,o.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"MANUAL";if(M.current&&r.query.room)try{var t;if(U.current){console.log("[Chat] Cleanup already in progress, skipping...");return}U.current=!0,console.log("[Chat] Starting cleanup (reason: ".concat(e,")")),"UNMOUNT"!==e&&r.query.room&&(null===(t=W.current)||void 0===t?void 0:t.connected)&&(console.log("[Chat] Emitting leaveRoom event"),W.current.emit("leaveRoom",r.query.room)),W.current&&"RECONNECT"!==e&&(console.log("[Chat] Cleaning up socket listeners..."),W.current.off("message"),W.current.off("previousMessages"),W.current.off("previousMessagesLoaded"),W.current.off("participantsUpdate"),W.current.off("aiMessageStart"),W.current.off("aiMessageChunk"),W.current.off("aiMessageComplete"),W.current.off("aiMessageError"),W.current.off("messageReactionUpdate"),W.current.off("session_ended"),W.current.off("error")),q.current&&(clearTimeout(q.current),q.current=null),O.current.clear(),_.current.clear(),P.current=!1,"MANUAL"===e&&M.current?(en({}),u(null),m(!1),er(!1),l([]),z.current.size>0&&z.current.clear()):"DISCONNECT"===e&&M.current&&u("채팅 연결이 끊어졌습니다. 재연결을 시도합니다."),console.log("[Chat] Cleanup completed (reason: ".concat(e,")"))}catch(e){console.error("[Chat] Cleanup error:",e),M.current&&u("채팅방 정리 중 오류가 발생했습니다.")}finally{U.current=!1}},[l,en,u,m,er,M,W,r.query.room]),eM=(0,o.useCallback)(()=>W.current?d?"connecting":c?"error":W.current.connected?"connected":"disconnected":"disconnected",[d,c,W]),{handleReactionAdd:eA,handleReactionRemove:eF,handleReactionUpdate:eD}=w(W,a,s,l),eU=(0,o.useCallback)(function(e,r){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{if(!Array.isArray(e))throw Error("Invalid messages format");l(r=>{let t=e.filter(e=>!(!e._id||O.current.has(e._id))&&(O.current.add(e._id),!0)),n=[...r,...t].sort((e,r)=>new Date(e.timestamp||0)-new Date(r.timestamp||0)),o=new Map;return n.forEach(e=>o.set(e._id,e)),Array.from(o.values())}),t?(ee(r),B.current=!0,X&&requestAnimationFrame(()=>G("auto"))):ee(r)}catch(e){throw console.error("Message processing error:",e),e}},[l,ee,X,G]),ez=(0,o.useCallback)(async()=>{var e,t;if(!(null===(e=W.current)||void 0===e?void 0:e.connected)||J){console.warn("Cannot load messages: Socket not connected or already loading");return}try{er(!0);let e=null===(t=s[0])||void 0===t?void 0:t.timestamp;q.current&&clearTimeout(q.current);let n=new Promise((t,n)=>{var o;W.current.emit("fetchPreviousMessages",{roomId:null==r?void 0:null===(o=r.query)||void 0===o?void 0:o.room,before:e}),W.current.once("previousMessagesLoaded",t),W.current.once("error",n)}),o=new Promise((e,r)=>{q.current=setTimeout(()=>{r(Error("Message loading timed out"))},1e4)}),l=await Promise.race([n,o]);l.messages&&eU(l.messages,l.hasMore,!1)}catch(e){console.error("Load previous messages error:",e),y.F.error("이전 메시지를 불러오는데 실패했습니다."),ee(!1)}finally{er(!1),q.current&&clearTimeout(q.current)}},[W,null==r?void 0:null===(e=r.query)||void 0===e?void 0:e.room,J,s,eU,ee]),e_=(0,o.useCallback)(()=>{W.current&&M.current&&(console.log("Setting up event listeners..."),W.current.on("participantsUpdate",e=>{M.current&&(console.log("Participants updated:",e),n(r=>({...r,participants:e||[]})))}),W.current.on("message",e=>{e&&M.current&&!P.current&&e._id&&!O.current.has(e._id)&&(console.log("Received message:",e),O.current.add(e._id),l(r=>r.some(r=>r._id===e._id)?r:[...r,e]),X&&G())}),W.current.on("previousMessages",e=>{if(M.current&&!P.current)try{if(P.current=!0,console.log("Previous messages response:",e),!e||"object"!=typeof e)throw Error("Invalid response format");let{messages:r=[],hasMore:t}=e,n=0===s.length;eU(r,t,n),er(!1)}catch(e){console.error("Error processing messages:",e),er(!1),u("메시지 처리 중 오류가 발생했습니다."),ee(!1)}finally{P.current=!1}}),ei(),W.current.on("messageReactionUpdate",e=>{M.current&&eD(e)}),W.current.on("session_ended",()=>{M.current&&(eT(),p.Z.logout(),r.replace("/?error=session_expired"))}),W.current.on("error",e=>{M.current&&(console.error("Socket error:",e),u(e.message||"채팅 연결에 문제가 발생했습니다."))}))},[X,G,s.length,eU,ei,ee,eT,r,eD,er,u]),{setupRoom:eP,joinRoom:eB,loadInitialMessages:eO,fetchRoomData:eq,handleSessionError:eZ}=C(W,a,M,r,n,u,l,ee,er,m,e_,eT,d,I,A,F,z.current,eU);(0,o.useEffect)(()=>{if(!W.current||!a)return;let e=()=>{!M.current||(console.log("Socket connected successfully"),h("connected"),V(!0),!r.query.room||F.current||A.current||E||(D.current=!0,eP().catch(e=>{console.error("Setup room error:",e),u("채팅방 연결에 실패했습니다.")})))},t=e=>{M.current&&(console.log("Socket disconnected:",e),h("disconnected"),D.current=!1,F.current=!1)},n=e=>{M.current&&(console.error("Socket connection error:",e),h("error"),u("채팅 서버와의 연결이 끊어졌습니다."))},o=e=>{M.current&&(console.log("Reconnection attempt ".concat(e)),h("connecting"))},s=()=>{M.current&&(console.log("Reconnected successfully"),h("connected"),V(!0),u(""),r.query.room&&eP().catch(e=>{console.error("Room reconnection error:",e),u("채팅방 재연결에 실패했습니다.")}))};return W.current.on("connect",e),W.current.on("disconnect",t),W.current.on("connect_error",n),W.current.on("reconnecting",o),W.current.on("reconnect",s),h(W.current.connected?"connected":"disconnected"),()=>{W.current&&(W.current.off("connect",e),W.current.off("disconnect",t),W.current.off("connect_error",n),W.current.off("reconnecting",o),W.current.off("reconnect",s))}},[r.query.room,eP,V,a,E,u]),(0,o.useEffect)(()=>{let e=async()=>{if(A.current)return;let e=p.Z.getCurrentUser();if(!e){r.replace("/?redirect="+r.asPath);return}if(a||i(e),!E&&r.query.room)try{A.current=!0,console.log("Initializing chat room..."),await eP()}catch(e){console.error("Chat initialization error:",e),u("채팅방 초기화에 실패했습니다.")}finally{A.current=!1}};M.current=!0,r.query.room&&e();let t=setInterval(()=>{M.current&&(p.Z.getCurrentUser()||(clearInterval(t),r.replace("/?redirect="+r.asPath)))},6e4);return()=>{var e;console.log("[Chat] Component unmounting..."),M.current=!1,clearInterval(t),q.current&&clearTimeout(q.current),(null===(e=W.current)||void 0===e?void 0:e.connected)&&r.query.room&&!U.current&&eT(S.UNMOUNT)}},[r,eT,eP,a,E,u]);let{fileInputRef:eW,uploading:eH,uploadProgress:eK,uploadError:eV,handleFileUpload:eX,handleFileSelect:e$,handleFileDrop:eJ,removeFilePreview:eY}=j(W,a,r),eG=(0,o.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eN(e))},[eN]);return{room:t,messages:s,streamingMessages:et,error:c,loading:d,connected:Z,currentUser:a,message:ec,showEmojiPicker:eu,showMentionList:ed,mentionFilter:em,mentionIndex:eg,filePreview:eh,uploading:ef,uploadProgress:ep,uploadError:ev,isNearBottom:X,hasMoreMessages:$,loadingMessages:J,fileInputRef:eW,messageInputRef:L,messagesEndRef:Y,socketRef:W,handleMessageChange:eR,handleMessageSubmit:eN,handleEmojiToggle:eS,handleKeyDown:eG,handleScroll:Q,handleLoadMore:ez,handleConnectionError:H,handleReconnect:K,getFilteredParticipants:eE,insertMention:eI,scrollToBottom:G,removeFilePreview:eL,handleReactionAdd:eA,handleReactionRemove:eF,cleanup:eT,setMessage:ey,setShowEmojiPicker:ex,setShowMentionList:ej,setMentionFilter:eb,setMentionIndex:ew,setStreamingMessages:en,setError:u,connectionStatus:eM(),messageLoadError:v,retryMessageLoad:(0,o.useCallback)(()=>{M.current&&(T.current=0,_.current.clear(),O.current.clear(),B.current=!1,eO(r.query.room))},[eO,r.query.room])}},I=(0,o.forwardRef)((e,r)=>{let{msg:t}=e,o=new Date(t.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 ");return console.log(o),(0,n.jsxs)("div",{className:"message-system",children:[t.content,o&&(0,n.jsx)("div",{className:"message-time",children:o})]})}),L=o.memo(I);var T=t(18237),M=t(6969);let A=(0,o.forwardRef)((e,r)=>{var t,s;let{user:l,size:i="md",className:c="",onClick:u,showInitials:d=!0,...m}=e,[g,h]=(0,o.useState)(""),[f,p]=(0,o.useState)(!1),v=(0,o.useCallback)(e=>e?e.startsWith("http")?e:"".concat("http://34.64.60.60:5000/").concat(e):null,[]);(0,o.useEffect)(()=>{let e=v(null==l?void 0:l.profileImage);e&&e!==g?(p(!1),h(e)):e||h("")},[null==l?void 0:l.profileImage,v,g]),(0,o.useEffect)(()=>{let e=()=>{try{let e=JSON.parse(localStorage.getItem("user")||"{}");if((null==l?void 0:l.id)===e.id&&e.profileImage!==l.profileImage){let r=v(e.profileImage);p(!1),h(r)}}catch(e){console.error("Profile update handling error:",e)}};return window.addEventListener("userProfileUpdate",e),()=>{window.removeEventListener("userProfileUpdate",e)}},[v,null==l?void 0:l.id,null==l?void 0:l.profileImage]);let y=(0,M.hA)(null==l?void 0:l.email);return(0,n.jsxs)(a.qE.Root,{ref:r,size:(e=>{switch(e){case"sm":return"sm";case"lg":return"lg";case"xl":return"xl";default:return"md"}})(i),className:c,onClick:u,src:g&&!f?g:void 0,style:{backgroundColor:y.backgroundColor,color:y.color,cursor:u?"pointer":"default",...m.style},...m,children:[g&&!f?(0,n.jsx)(a.qE.Image,{onError:e=>{e.preventDefault(),p(!0),console.debug("Avatar image load failed:",{user:null==l?void 0:l.name,email:null==l?void 0:l.email,imageUrl:g})},alt:"".concat(null==l?void 0:l.name,"'s profile")}):null,(0,n.jsx)(a.qE.Fallback,{style:{backgroundColor:y.backgroundColor,color:y.color,fontWeight:"500"},children:d?(null==l?void 0:null===(s=l.name)||void 0===s?void 0:null===(t=s[0])||void 0===t?void 0:t.toUpperCase())||"?":""})]})});A.displayName="PersistentAvatar";let F=e=>{let{messageType:r="text",participants:t=[],readers:s=[],className:l="",socketRef:a=null,messageId:c=null,messageRef:u=null,currentUserId:d=null}=e,[m,g]=(0,o.useState)(s||[]),[h,f]=(0,o.useState)(!1),[p,v]=(0,o.useState)(!1),y=(0,o.useRef)(null),x=(0,o.useRef)(null),j=(0,o.useMemo)(()=>"system"===r?[]:t.filter(e=>{let r=e._id||e.id,t=!m.some(e=>e.userId===r),n=r!==d;return t&&n}),[t,m,d,r]),b=(0,o.useMemo)(()=>"system"===r?0:j.length,[j.length,r]),w=(0,o.useCallback)(async()=>{if(c&&d&&!p&&"system"!==r&&(null==a?void 0:a.current))try{a.current.emit("markMessagesAsRead",{messageIds:[c]}),v(!0),g(e=>e.some(e=>e.userId===d)?e:[...e,{userId:d,readAt:new Date}])}catch(e){console.error("Error marking message as read:",e)}},[c,d,p,r,a]);(0,o.useEffect)(()=>{if((null==u?void 0:u.current)&&d&&!p&&"system"!==r){if(m.some(e=>e.userId===d)){v(!0);return}return x.current=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!p&&w()})},{root:null,rootMargin:"0px",threshold:.5}),x.current.observe(u.current),()=>{x.current&&x.current.disconnect()}}},[u,d,p,r,m,w]),(0,o.useCallback)(()=>{if(0===b)return"모두 읽음";let e=j.map(e=>e.name);return"".concat(e.join(", "),"이 읽지 않음")},[b,j]);let k=(0,o.useCallback)(e=>{let{userId:r,messageIds:t,timestamp:n}=e;c&&t.includes(c)&&g(e=>e.some(e=>e.userId===r)?e:[...e,{userId:r,readAt:n||new Date}])},[c]),R=(0,o.useCallback)(e=>{g(r=>r.filter(r=>e.some(e=>e._id===r.userId||e.id===r.userId)))},[]);return((0,o.useEffect)(()=>{g(s)},[s]),(0,o.useEffect)(()=>{if(null==a?void 0:a.current)return a.current.on("messagesRead",k),a.current.on("participantsUpdate",R),()=>{a.current&&(a.current.off("messagesRead",k),a.current.off("participantsUpdate",R))}},[a,k,R]),"system"===r)?null:0===b?(0,n.jsx)("div",{className:"read-status ".concat(l),ref:y,role:"status","aria-label":"모든 참여자가 메시지를 읽었습니다",children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,n.jsx)(T.NX7,{size:12,style:{color:"var(--vapor-color-success)"}}),(0,n.jsx)(T.NX7,{size:12,style:{color:"var(--vapor-color-success)",marginLeft:"-6px"}})]}),(0,n.jsx)(i.x,{typography:"caption",style:{fontSize:"0.65rem",color:"var(--vapor-color-text-muted)"},children:"모두 읽음"})]})}):(0,n.jsx)("div",{className:"read-status ".concat(l),ref:y,role:"status","aria-label":"".concat(b,"명이 메시지를 읽지 않았습니다"),children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsx)(T.NX7,{size:12,style:{color:"var(--vapor-color-gray-400)"}}),b>0&&(0,n.jsxs)(i.x,{typography:"caption",style:{fontSize:"0.65rem",color:"var(--vapor-color-text-muted)"},children:[b,"명 안 읽음"]})]})})};F.displayName="ReadStatus";let D=o.memo(F);var U=t(32726),z=t(73935),_=t(26638),P=t(73814);let B=function(e){let{onSelect:r}=e;return(0,n.jsx)("div",{className:"emoji-picker-wrapper",children:(0,n.jsx)(P.Z,{data:_,onEmojiSelect:r,theme:"light",set:"native",locale:"ko",previewPosition:"none",skinTonePosition:"none",emojiButtonSize:30,emojiSize:20,maxFrequentRows:4,perLine:9})})},O=o.memo(e=>{let{messageId:r="",messageContent:t="",reactions:s={},currentUserId:l=null,onReactionAdd:a=()=>{},onReactionRemove:i=()=>{},isMine:c=!1,room:u=null}=e,[m,g]=(0,o.useState)(!1),[h,f]=(0,o.useState)({}),[p,v]=(0,o.useState)(0),x=(0,o.useRef)(null),j=(0,o.useRef)(null),b=(0,o.useRef)(null),w=(0,o.useRef)({});(0,o.useRef)(null);let k=(0,o.useCallback)(e=>{var r,t;let n=null===(r=x.current)||void 0===r?void 0:r.contains(e.target),o=null===(t=j.current)||void 0===t?void 0:t.contains(e.target);n||o||g(!1)},[]);(0,o.useEffect)(()=>(m&&document.addEventListener("mousedown",k),()=>{document.removeEventListener("mousedown",k)}),[m,k]);let R=(0,o.useCallback)(async()=>{try{await navigator.clipboard.writeText(t),y.F.success("메시지가 클립보드에 복사되었습니다.")}catch(e){console.error("Copy failed:",e),y.F.error("메시지 복사에 실패했습니다.")}},[t]),N=(0,o.useCallback)(e=>{try{var t;let n=e.native||e;(null==s?void 0:null===(t=s[n])||void 0===t?void 0:t.includes(l))?null==i||i(r,n):null==a||a(r,n),g(!1)}catch(e){console.error("Reaction handling error:",e)}},[r,s,l,a,i]),C=(0,o.useCallback)(e=>{f(r=>({...r,[e]:!r[e]}))},[]),S=(0,o.useCallback)((e,r)=>{if(!r||!(null==u?void 0:u.participants))return"";if(!Array.isArray(u.participants))return console.warn("room.participants is not an array:",u.participants),"";let t=new Map(u.participants.map(e=>[String(e._id||e.id),e.name]));return[...new Set(r.map(e=>{let r=String(e);return r===String(l)?"나":t.get(r)||"알 수 없는 사용자"}))].sort((e,r)=>"나"===e?-1:"나"===r?1:e.localeCompare(r)).join(", ")},[l,u]),E=(0,o.useCallback)(()=>s&&0!==Object.keys(s).length?(0,n.jsx)("div",{className:"message-reactions",children:Object.entries(s).map(e=>{let[t,s]=e,a="reaction-".concat(r,"-").concat(t);w.current[t]||(w.current[t]=o.createRef());let i=S(t,s);return(0,n.jsx)(o.Fragment,{children:(0,n.jsxs)(d.z,{ref:w.current[t],id:a,size:"sm",variant:s.includes(l)?"solid":"outline",color:s.includes(l)?"primary":"secondary",className:"reaction-badge",onClick:()=>N(t),onMouseEnter:()=>C(t),onMouseLeave:()=>C(t),"data-bs-toggle":"tooltip","data-bs-placement":"top",title:i,children:[(0,n.jsx)("span",{className:"reaction-emoji",children:t}),(0,n.jsx)("span",{className:"reaction-count",children:s.length})]})},t)})}):null,[s,r,l,h,N,C,S]),I=(0,o.useCallback)(e=>{e.stopPropagation(),g(e=>!e)},[]),L=(0,o.useCallback)(()=>{if(!j.current)return{top:0,left:0};let e=j.current.getBoundingClientRect();e.height;let r=e.top-350-15,t=e.left;return r<10&&(r=e.bottom+15),t+350>window.innerWidth&&(t=window.innerWidth-350-10),t<10&&(t=10),{top:r,left:t}},[]);return(0,n.jsxs)("div",{className:"flex flex-col ".concat(c?"items-end":"items-start"),ref:b,children:[E(),(0,n.jsx)("div",{className:"message-actions-wrapper ".concat(c?"mine":""),children:(0,n.jsxs)("div",{className:"message-actions",style:{display:"flex",alignItems:"center",gap:"var(--vapor-space-100)"},children:[(0,n.jsxs)("div",{style:{position:"relative"},children:[(0,n.jsx)(U.h,{ref:j,size:"sm",variant:"outline",onClick:I,"aria-label":"리액션 추가",children:(0,n.jsx)(T.lME,{size:16})}),m&&z.createPortal((0,n.jsx)("div",{ref:x,style:{position:"fixed",...L(),zIndex:9999},onClick:e=>e.stopPropagation(),children:(0,n.jsx)("div",{className:"emoji-picker-container",style:{backgroundColor:"var(--vapor-color-normal)",borderRadius:"var(--vapor-radius-lg)",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",border:"1px solid var(--vapor-color-border)"},children:(0,n.jsx)(B,{onSelect:N,emojiSize:20,perLine:8,theme:"light"})})}),document.body)]}),(0,n.jsx)(U.h,{size:"sm",variant:"outline",onClick:R,"aria-label":"메시지 복사",children:(0,n.jsx)(T.TIy,{size:16})})]})})]})});var q=t(34585),Z=t(13384),W=t(93809),H=t(95343),K=t(34209),V=t(84283);let X=o.memo(e=>{let{content:r,isAI:t=!1}=e,[s,l]=(0,o.useState)(new Map),a=(0,o.useCallback)(async(e,r)=>{try{await navigator.clipboard.writeText(e),l(e=>new Map(e).set(r,!0)),y.F.success("코드가 클립보드에 복사되었습니다."),setTimeout(()=>{l(e=>{let t=new Map(e);return t.delete(r),t})},1e3)}catch(e){console.error("Failed to copy:",e),y.F.error("복사에 실패했습니다.")}},[]),c=(0,o.useMemo)(()=>e=>{let r;let t=/@(wayneAI|consultingAI|[\w.-]+)/g,o=[],s=0;for(;null!==(r=t.exec(e));){r.index>s&&o.push((0,n.jsx)("span",{children:e.slice(s,r.index)},"text-".concat(s)));let t=r[1],l="wayneAI"===t||"consultingAI"===t,a=l?"wayneAI"===t?"Wayne AI":"Consulting AI":t,i=l?"mention mention-bot ".concat("wayneAI"===t?"mention-wayne":"mention-consulting"):"mention mention-user";o.push((0,n.jsxs)("span",{className:i,children:["@",a]},"mention-".concat(r.index))),s=r.index+r[0].length}return s<e.length&&o.push((0,n.jsx)("span",{children:e.slice(s)},"text-".concat(s))),o},[]),u=(0,o.useMemo)(()=>({p:e=>{let{children:r}=e;return 1!==r.length||"string"!=typeof r[0]||r[0].includes("\n")?(0,n.jsx)(i.x,{typography:"body2",children:r}):(0,n.jsx)(i.x,{typography:"body2",children:c(r[0])})},code(e){let{node:r,inline:t,className:o,children:l,...i}=e,c=/language-(\w+)/.exec(o||""),u=Math.random().toString(36).substr(2,9);return!t&&c?(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsx)("button",{onClick:()=>a(String(l).replace(/\n$/,""),u),className:"absolute right-2 top-2 p-2 rounded bg-gray-800/50 hover:bg-gray-800/80 transition-all duration-200 opacity-0 group-hover:opacity-100 z-10",title:"코드 복사",children:s.get(u)?(0,n.jsx)(T.eje,{size:16,style:{color:"var(--vapor-color-success)"}}):(0,n.jsx)(T.TIy,{size:16,style:{color:"var(--vapor-color-gray-500)"}})}),(0,n.jsx)(K.Z,{style:V.Ro,language:c[1],PreTag:"div",showLineNumbers:!0,wrapLines:!0,...i,children:String(l).replace(/\n$/,"")})]}):(0,n.jsx)("code",{className:"rounded px-1.5 py-0.5 text-sm bg-black/10",...i,children:l})},h1:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("h1",{className:"md-heading md-h1",...o,children:t})},h2:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("h2",{className:"md-heading md-h2",...o,children:t})},h3:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("h3",{className:"md-heading md-h3",...o,children:t})},ul:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("ul",{className:"md-list md-ul",...o,children:t})},ol:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("ol",{className:"md-list md-ol",...o,children:t})},li:e=>{let{node:r,children:t,...o}=e,s=r.children.some(e=>"element"===e.type&&"input"===e.tagName&&"checkbox"===e.properties.type);return(0,n.jsx)("li",{className:"md-list-item ".concat(s?"list-none":""),...o,children:t})},a:e=>{let{node:r,children:t,href:o,...s}=e;return(0,n.jsx)("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"md-link",...s,children:t})},img:e=>{let{node:r,src:t,alt:o,...s}=e;return(0,n.jsx)("img",{src:t,alt:o,className:"md-image",loading:"lazy",onError:e=>{e.target.src="/placeholder-image.png"},...s})},table:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("div",{className:"md-table-wrapper",children:(0,n.jsx)("table",{className:"md-table",...o,children:t})})},blockquote:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("blockquote",{className:"md-blockquote",...o,children:t})},em:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("em",{className:"md-italic",...o,children:t})},strong:e=>{let{node:r,children:t,...o}=e;return(0,n.jsx)("strong",{className:"md-bold",...o,children:t})}}),[c,a,s]),d=(0,o.useMemo)(()=>"string"==typeof r&&!r.includes("```")&&!r.includes("`")&&!r.includes("#")&&!r.includes("*")&&!r.includes("_")&&!r.includes("[")&&!r.includes("|"),[r]);return"string"!=typeof r?String(r):d&&r.includes("@")?(0,n.jsx)(i.x,{typography:"body2",className:"message-text",children:c(r)}):(0,n.jsx)(q.U,{remarkPlugins:[Z.Z,W.Z,H.Z],components:u,children:r})});var $=t(48764).lW;let J=e=>{let{handleViewInNewTab:r,handleFileDownload:t}=e;return(0,n.jsxs)("div",{className:"file-actions mt-2 pt-2 border-t border-gray-200",children:[(0,n.jsxs)(d.z,{size:"sm",variant:"outline",onClick:r,title:"새 탭에서 보기",children:[(0,n.jsx)(T.nK8,{size:16}),(0,n.jsx)("span",{children:"새 탭에서 보기"})]}),(0,n.jsxs)(d.z,{size:"sm",variant:"outline",onClick:t,title:"다운로드",children:[(0,n.jsx)(T._8t,{size:16}),(0,n.jsx)("span",{children:"다운로드"})]})]})},Y=(0,o.forwardRef)((e,r)=>{var t;let{msg:s={file:{mimetype:"",filename:"",originalname:"",size:0}},isMine:l=!1,currentUser:a=null,onReactionAdd:c,onReactionRemove:m,room:g=null,messageRef:h,socketRef:f}=e,[p,v]=(0,o.useState)(null),[y,j]=(0,o.useState)("");if((0,o.useEffect)(()=>{if(null==s?void 0:s.file)try{let e=x.Z.getThumbnailUrl(s.file,{preview:!0},s.room);j(e),console.debug("Preview URL generated:",{fileInfo:s.file,roomId:s.room,url:e})}catch(e){console.error("Preview URL generation error:",e),v("미리보기를 생성할 수 없습니다.")}},[null==s?void 0:s.file,null==s?void 0:s.room]),!(null==s?void 0:s.file))return console.error("File data is missing:",s),null;let b=new Date(s.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),w=()=>{var e;let r=(null===(e=s.file)||void 0===e?void 0:e.mimetype)||"",t={className:"w-5 h-5 flex-shrink-0"};return r.startsWith("image/")?(0,n.jsx)(T.XBm,{...t,color:"#00C853"}):r.startsWith("video/")?(0,n.jsx)(T.HiY,{...t,color:"#2196F3"}):r.startsWith("audio/")?(0,n.jsx)(T.IbZ,{...t,color:"#9C27B0"}):(0,n.jsx)(T.p5_,{...t,color:"#ffffff"})},k=e=>{try{if(!e)return"Unknown File";let r=e.replace(/-/g,"+").replace(/_/g,"/"),t=r.length%4,n=t?r+"=".repeat(4-t):r;if(n.match(/^[A-Za-z0-9+/=]+$/))return $.from(n,"base64").toString("utf8");return decodeURIComponent(e)}catch(r){return console.error("Filename decoding error:",r),e}},R=async e=>{e.preventDefault(),e.stopPropagation(),v(null);try{var r;if(!(null===(r=s.file)||void 0===r?void 0:r.filename))throw Error("파일 정보가 없습니다.");console.log("Download initiated for:",s.file);let e=x.Z.getDownloadUrl(s.file,s.room);console.log("Generated download URL:",e);try{let r=await fetch(e);if(!r.ok)throw Error("다운로드 실패: ".concat(r.status," ").concat(r.statusText));let t=await r.blob(),n=document.createElement("a"),o=URL.createObjectURL(t);n.href=o,n.download=k(s.file.originalname)||s.file.filename,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),console.log("File downloaded successfully via fetch")}catch(t){console.warn("Fetch download failed, trying direct link method:",t);let r=document.createElement("a");r.href=e,r.download=k(s.file.originalname)||s.file.filename,r.target="_blank",document.body.appendChild(r),r.click(),document.body.removeChild(r),console.log("File download initiated via direct link")}}catch(e){console.error("File download error:",e),v(e.message||"파일 다운로드 중 오류가 발생했습니다.")}},N=e=>{e.preventDefault(),e.stopPropagation(),v(null);try{var r;if(!(null===(r=s.file)||void 0===r?void 0:r.filename))throw Error("파일 정보가 없습니다.");let e=x.Z.getPreviewUrl(s.file,s.room),t=window.open(e,"_blank");if(!t)throw Error("팝업이 차단되었습니다. 팝업 차단을 해제해주세요.");t.opener=null,console.debug("File view in new tab:",{filename:s.file.filename,viewUrl:e})}catch(e){console.error("File view error:",e),v(e.message||"파일 보기 중 오류가 발생했습니다.")}},C=e=>{try{var r;if(!(null==s?void 0:null===(r=s.file)||void 0===r?void 0:r.filename)||!y)return(0,n.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-100",children:(0,n.jsx)(T.XBm,{className:"w-8 h-8 text-gray-400"})});return(0,n.jsx)("div",{className:"bg-gray-100",children:(0,n.jsx)("img",{src:y,alt:e,className:"object-cover rounded-sm w-full h-auto",onLoad:()=>{console.debug("Image loaded successfully:",e)},onError:r=>{console.error("Image load error:",{error:r.error,originalname:e,previewUrl:y}),r.target.onerror=null,r.target.src="/images/placeholder-image.png",v("이미지를 불러올 수 없습니다.")},loading:"lazy"})})}catch(e){return console.error("Image preview error:",e),v(e.message||"이미지 미리보기를 불러올 수 없습니다."),(0,n.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-100",children:(0,n.jsx)(T.XBm,{className:"w-8 h-8 text-gray-400"})})}};return(0,n.jsx)("div",{className:"messages",children:(0,n.jsxs)("div",{className:"message-group ".concat(l?"mine":"yours"),children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(A,{user:l?a:s.sender,size:"md",className:"flex-shrink-0",showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:l?"나":null===(t=s.sender)||void 0===t?void 0:t.name})]}),(0,n.jsxs)("div",{className:"message-bubble ".concat(l?"message-mine":"message-other"," last file-message"),children:[(0,n.jsxs)("div",{className:"message-content",children:[p&&(0,n.jsxs)(u.U,{color:"danger",className:"mb-3 d-flex align-items-center",children:[(0,n.jsx)(T.oC6,{className:"w-4 h-4 me-2"}),(0,n.jsx)("span",{children:p}),(0,n.jsx)(d.z,{variant:"ghost",size:"sm",className:"ms-auto","aria-label":"Close",onClick:()=>v(null),children:"\xd7"})]}),(()=>{var e,r,t;let o=(null===(e=s.file)||void 0===e?void 0:e.mimetype)||"",l=k((null===(r=s.file)||void 0===r?void 0:r.originalname)||"Unknown File"),a=x.Z.formatFileSize((null===(t=s.file)||void 0===t?void 0:t.size)||0),c="overflow-hidden",u="flex items-center gap-3 p-1 mt-2";return o.startsWith("image/")?(0,n.jsxs)("div",{className:c,children:[C(l),(0,n.jsx)("div",{className:u,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",l]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:a})]})}),(0,n.jsx)(J,{handleViewInNewTab:N,handleFileDownload:R})]}):o.startsWith("video/")?(0,n.jsxs)("div",{className:c,children:[(0,n.jsx)("div",{className:"bg-gray-900",children:y?(0,n.jsxs)("video",{className:"object-cover rounded-sm w-full h-auto",controls:!0,preload:"metadata","aria-label":"".concat(l," 비디오"),crossOrigin:"use-credentials",children:[(0,n.jsx)("source",{src:y,type:o}),(0,n.jsx)("track",{kind:"captions"}),"비디오를 재생할 수 없습니다."]}):(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsx)(T.HiY,{className:"w-8 h-8 text-gray-400"})})}),(0,n.jsx)("div",{className:u,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",l]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:a})]})}),(0,n.jsx)(J,{handleViewInNewTab:N,handleFileDownload:R})]}):o.startsWith("audio/")?(0,n.jsxs)("div",{className:c,children:[(0,n.jsx)("div",{className:u,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)(i.x,{typography:"body2",className:"font-medium truncate",children:[w()," ",l]}),(0,n.jsx)("span",{className:"text-sm text-muted",children:a})]})}),(0,n.jsx)("div",{className:"px-3 pb-3",children:y&&(0,n.jsxs)("audio",{className:"w-full",controls:!0,preload:"metadata","aria-label":"".concat(l," 오디오"),crossOrigin:"use-credentials",children:[(0,n.jsx)("source",{src:y,type:o}),"오디오를 재생할 수 없습니다."]})}),(0,n.jsx)(J,{handleViewInNewTab:N,handleFileDownload:R})]}):(0,n.jsxs)("div",{className:c,children:[(0,n.jsx)("div",{className:u,children:(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)("div",{className:"font-medium truncate",children:[w()," ",l]}),(0,n.jsx)(i.x,{typography:"body2",as:"span",children:a})]})}),(0,n.jsx)(J,{handleViewInNewTab:N,handleFileDownload:R})]})})(),s.content&&(0,n.jsx)("div",{className:"mt-3",children:(0,n.jsx)(X,{content:s.content})})]}),(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",title:new Date(s.timestamp).toLocaleString("ko-KR"),children:b}),(0,n.jsx)(D,{messageType:s.type,participants:g.participants,readers:s.readers,messageId:s._id,messageRef:h,currentUserId:a.id,socketRef:f})]})]}),(0,n.jsx)(O,{messageId:s._id,messageContent:s.content,reactions:s.reactions,currentUserId:null==a?void 0:a.id,onReactionAdd:c,onReactionRemove:m,isMine:l,room:g})]})})}),G=o.memo(Y),Q=(0,o.forwardRef)((e,r)=>{var t,s;let{msg:l={},isMine:a=!1,currentUser:i=null,onReactionAdd:c,onReactionRemove:u,room:d=null,messageRef:m,socketRef:g}=e,h=new Date(l.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),f=(0,o.useMemo)(()=>{var e;let r=a?null==i?void 0:i.email:null===(e=l.sender)||void 0===e?void 0:e.email;if(!r)return{};let t=(0,M.FV)(r),n=(0,M.pJ)(t);return{backgroundColor:t,color:n}},[a,null==i?void 0:i.email,null===(t=l.sender)||void 0===t?void 0:t.email]),p=a?i:l.sender;return(0,n.jsx)("div",{className:"messages",children:(0,n.jsxs)("div",{className:"message-group ".concat(a?"mine":"yours"),children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(A,{user:p,size:"lg",style:f,showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:a?"나":null===(s=l.sender)||void 0===s?void 0:s.name})]}),(0,n.jsxs)("div",{className:"message-bubble ".concat(a?"message-mine":"message-other"," last relative group"),children:[(0,n.jsx)("div",{className:"message-content",children:(0,n.jsx)(X,{content:l.content})}),(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",children:h}),(0,n.jsx)(D,{messageType:l.type,participants:d.participants,readers:l.readers,messageId:l._id,messageRef:m,currentUserId:i.id,socketRef:g})]})]}),(0,n.jsx)(O,{messageId:l._id,messageContent:l.content,reactions:l.reactions,currentUserId:null==i?void 0:i.id,onReactionAdd:c,onReactionRemove:u,isMine:a,room:d})]})})});Q.defaultProps={msg:{},isMine:!1,currentUser:null,onReactionAdd:()=>{},onReactionRemove:()=>{},room:null};let ee=o.memo(Q),er=(0,o.forwardRef)((e,r)=>{let{msg:t={},isStreaming:o=!1,isMine:s=!1,currentUser:l=null,onReactionAdd:a,onReactionRemove:i,room:c=null,messageRef:u,socketRef:d}=e,m=new Date(t.timestamp).toLocaleString("ko-KR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\./g,"년").replace(/\s/g," ").replace("일 ","일 "),g={name:"wayneAI"===t.aiType?"Wayne AI":"Consulting AI",email:"wayneAI"===t.aiType?"ai@wayne.ai":"ai@consulting.ai",avatarInitial:"wayneAI"===t.aiType?"W":"C"};return(0,n.jsx)("div",{ref:r,className:"system-message",children:(0,n.jsxs)("div",{className:"message-group yours",children:[(0,n.jsxs)("div",{className:"message-sender-info",children:[(0,n.jsx)(A,{user:g,size:"lg",showInitials:!0}),(0,n.jsx)("span",{className:"sender-name",children:g.name})]}),(0,n.jsxs)("div",{className:"message-bubble message-ai last relative group",children:[(0,n.jsx)("div",{className:"message-content",children:o?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(X,{content:t.content}),(0,n.jsxs)("div",{className:"typing-indicator",children:[(0,n.jsx)("span",{}),(0,n.jsx)("span",{}),(0,n.jsx)("span",{})]})]}):(0,n.jsx)(X,{content:t.content})}),!o&&(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("div",{className:"message-time mr-3",children:m}),(0,n.jsx)(D,{messageType:t.type,participants:c.participants,readers:t.readers,messageId:t._id,messageRef:u,currentUserId:l.id,socketRef:d})]})]}),(0,n.jsx)(O,{messageId:t._id,messageContent:t.content,reactions:t.reactions,currentUserId:null==l?void 0:l.id,onReactionAdd:a,onReactionRemove:i,isMine:s,room:c})]})})});er.defaultProps={msg:{},isStreaming:!1,currentUser:null,onReactionAdd:()=>{},onReactionRemove:()=>{},room:null};let et=o.memo(er);class en{logDebug(e,r){console.debug("[ScrollHandler] ".concat(e,":"),{...r,timestamp:new Date().toISOString()})}saveScrollPosition(){let e=this.containerRef.current;e&&(this.logDebug("saveScrollPosition",{scrollHeight:e.scrollHeight,scrollTop:e.scrollTop}),this.scrollHeightBeforeLoadRef.current=e.scrollHeight,this.scrollTopBeforeLoadRef.current=e.scrollTop,this.isLoadingOldMessages.current=!0)}async startLoadingMessages(){return this.isLoadingRef.current||this.loadMoreTriggeredRef.current?(this.logDebug("startLoadingMessages prevented",{isLoading:this.isLoadingRef.current,loadMoreTriggered:this.loadMoreTriggeredRef.current}),!1):(this.saveScrollPosition(),this.isLoadingRef.current=!0,this.loadMoreTriggeredRef.current=!0,!0)}restoreScrollPosition(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],r=this.containerRef.current;if(r&&this.isLoadingOldMessages.current)try{this.isRestoringScroll.current=!0,this.temporaryDisableScroll.current=!0;let t=r.scrollHeight,n=t-this.scrollHeightBeforeLoadRef.current,o=this.scrollTopBeforeLoadRef.current+n;if(this.logDebug("restoreScrollPosition",{newScrollHeight:t,heightDifference:n,newScrollTop:o,immediate:e}),e){let e=r.style.scrollBehavior;r.style.scrollBehavior="auto",r.scrollTop=o,requestAnimationFrame(()=>{r.style.scrollBehavior=e,this.temporaryDisableScroll.current=!1,this.isRestoringScroll.current=!1})}else r.scrollTo({top:o,behavior:"smooth"}),this.temporaryDisableScroll.current=!1,this.isRestoringScroll.current=!1}finally{this.resetScrollState()}}resetScrollState(){this.scrollHeightBeforeLoadRef.current=0,this.scrollTopBeforeLoadRef.current=0,this.isLoadingOldMessages.current=!1,this.isLoadingRef.current=!1,this.loadMoreTriggeredRef.current=!1,setTimeout(()=>{this.isRestoringScroll.current=!1,this.temporaryDisableScroll.current=!1},100)}shouldScrollToBottom(e,r){return!this.isLoadingOldMessages.current&&!this.isRestoringScroll.current&&(r||this.isNearBottom.current)}updateScrollPosition(){let e=this.containerRef.current;if(!e)return null;let{scrollTop:r,scrollHeight:t,clientHeight:n}=e;this.isNearBottom.current=t-r-n<100;let o={isAtTop:r<this.SCROLL_THRESHOLD,isAtBottom:this.isNearBottom.current,scrollTop:r,scrollHeight:t,clientHeight:n};return this.logDebug("updateScrollPosition",o),o}async handleScroll(e,r){let{hasMoreMessages:t,loadingMessages:n,onLoadMore:o,onScrollPositionChange:s,onScroll:l}=r;if(this.temporaryDisableScroll.current||this.isRestoringScroll.current){this.logDebug("handleScroll skipped",{temporaryDisableScroll:this.temporaryDisableScroll.current,isRestoringScroll:this.isRestoringScroll.current});return}let a=this.updateScrollPosition();a&&(this.scrollTimeoutRef.current&&clearTimeout(this.scrollTimeoutRef.current),this.scrollTimeoutRef.current=setTimeout(async()=>{if(a.isAtTop&&t&&!n&&(this.logDebug("handleScroll loadMore",{isAtTop:a.isAtTop,hasMoreMessages:t,loadingMessages:n}),await this.startLoadingMessages()))try{await o()}catch(e){console.error("Load more error:",e),this.resetScrollState()}null==s||s(a),null==l||l(a)},this.SCROLL_DEBOUNCE_DELAY))}scrollToBottom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";if(this.isLoadingOldMessages.current||this.isRestoringScroll.current)return;let r=this.containerRef.current;r&&requestAnimationFrame(()=>{try{let t=r.scrollHeight,n=r.clientHeight,o=t-n;r.scrollTo({top:o,behavior:e}),this.logDebug("scrollToBottom",{scrollHeight:t,height:n,maxScrollTop:o,behavior:e})}catch(e){console.error("Scroll to bottom error:",e),r.scrollTop=r.scrollHeight}})}cleanup(){this.scrollTimeoutRef.current&&clearTimeout(this.scrollTimeoutRef.current),this.scrollRestorationRef.current&&cancelAnimationFrame(this.scrollRestorationRef.current)}constructor(e){this.containerRef=e,this.scrollHeightBeforeLoadRef={current:0},this.scrollTopBeforeLoadRef={current:0},this.isLoadingOldMessages={current:!1},this.isRestoringScroll={current:!1},this.isNearBottom={current:!0},this.scrollTimeoutRef={current:null},this.scrollRestorationRef={current:null},this.temporaryDisableScroll={current:!1},this.scrollBehavior={current:"smooth"},this.isLoadingRef={current:!1},this.loadMoreTriggeredRef={current:!1},this.SCROLL_THRESHOLD=30,this.SCROLL_DEBOUNCE_DELAY=100}}let eo=o.memo(e=>{let{text:r}=e;return(0,n.jsxs)("div",{className:"loading-messages",children:[(0,n.jsx)("div",{className:"spinner-border spinner-border-sm text-primary",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("span",{className:"text-secondary text-sm",children:r})]})});eo.displayName="LoadingIndicator";let es=o.memo(()=>(0,n.jsx)("div",{className:"message-history-end",children:(0,n.jsx)("span",{className:"text-secondary text-sm",children:"더 이상 불러올 메시지가 없습니다."})}));es.displayName="MessageHistoryEnd";let el=o.memo(()=>(0,n.jsxs)("div",{className:"empty-messages",children:[(0,n.jsx)(i.x,{typography:"body1",children:"아직 메시지가 없습니다."}),(0,n.jsx)(i.x,{typography:"body2",color:"neutral-weak",children:"첫 메시지를 보내보세요!"})]}));el.displayName="EmptyMessages";let ea=e=>{let{messages:r=[],streamingMessages:t={},currentUser:s=null,room:l=null,loadingMessages:a=!1,hasMoreMessages:i=!0,onScroll:c=()=>{},onLoadMore:u=()=>{},onReactionAdd:d=()=>{},onReactionRemove:m=()=>{},messagesEndRef:g,socketRef:h,scrollToBottomOnNewMessage:f=!0,onScrollPositionChange:p=()=>{}}=e,v=(0,o.useRef)(null),y=(0,o.useRef)(null),x=(0,o.useRef)(!1),j=(0,o.useRef)(r.length),b=(0,o.useRef)(!0),w=(0,o.useRef)(null),k=(0,o.useRef)(new en(v));(0,o.useCallback)((e,t)=>{console.debug("[ChatMessages] ".concat(e,":"),{...t,loadingMessages:a,hasMoreMessages:i,isLoadingOldMessages:k.current.isLoadingOldMessages.current,messageCount:r.length,timestamp:new Date().toISOString(),isInitialLoad:b.current})},[a,i,r.length]);let R=(0,o.useCallback)(e=>null!=e&&!!e.sender&&null!=s&&!!s.id&&(e.sender._id===s.id||e.sender.id===s.id||e.sender===s.id),[null==s?void 0:s.id]),N=(0,o.useCallback)(e=>{k.current.handleScroll(e,{hasMoreMessages:i,loadingMessages:a,onLoadMore:u,onScrollPositionChange:p,onScroll:c})},[i,a,u,p,c]);(0,o.useLayoutEffect)(()=>{if(r.length>j.current){let e=r.slice(j.current),t=e[e.length-1];f&&k.current.shouldScrollToBottom(t,R(t))&&k.current.scrollToBottom("smooth"),j.current=r.length}},[r,f,R]),(0,o.useLayoutEffect)(()=>{!a&&k.current.isLoadingOldMessages.current&&(k.current.scrollRestorationRef.current&&cancelAnimationFrame(k.current.scrollRestorationRef.current),k.current.scrollRestorationRef.current=requestAnimationFrame(()=>{k.current.restoreScrollPosition(!0)}))},[a]),(0,o.useEffect)(()=>{let e=Object.values(t);if(e.length>0){let r=e[e.length-1];r&&k.current.shouldScrollToBottom(r,R(r))&&k.current.scrollToBottom("smooth")}},[t,R]),(0,o.useLayoutEffect)(()=>{!x.current&&r.length>0&&(k.current.scrollToBottom("auto"),x.current=!0,b.current&&setTimeout(()=>{b.current=!1},1e3))},[r.length]),(0,o.useEffect)(()=>{let e=v.current;if(e)return e.addEventListener("scroll",N,{passive:!0}),()=>{k.current.cleanup(),w.current&&clearTimeout(w.current),e.removeEventListener("scroll",N)}},[N]);let C=(0,o.useMemo)(()=>Array.isArray(r)?[...r,...Object.values(t||{})].sort((e,r)=>(null==e?void 0:e.timestamp)&&(null==r?void 0:r.timestamp)?new Date(e.timestamp)-new Date(r.timestamp):0):[],[r,t]),S=(0,o.useCallback)((e,r)=>{if(!e||!L||!G||!ee||!et)return console.error("Message component undefined:",{msgType:null==e?void 0:e.type,hasSystemMessage:!!L,hasFileMessage:!!G,hasUserMessage:!!ee,hasAIMessage:!!et}),null;let t=r===C.length-1,o={system:L,file:G,ai:et}[e.type]||ee;return(0,n.jsx)(o,{ref:t?y:null,currentUser:s,room:l,onReactionAdd:d,onReactionRemove:m,msg:e,content:e.content,isMine:"system"!==e.type?R(e):void 0,isStreaming:"ai"===e.type?e.isStreaming||!1:void 0,messageRef:e,socketRef:h},e._id||"msg-".concat(r))},[C.length,s,l,R,d,m,h]);return(0,n.jsxs)("div",{className:"message-list",ref:v,role:"log","aria-live":"polite","aria-atomic":"false",children:[a&&(0,n.jsx)(eo,{text:"이전 메시지를 불러오는 중..."}),!a&&!i&&r.length>0&&(0,n.jsx)(es,{}),0===C.length?(0,n.jsx)(el,{}):C.map((e,r)=>S(e,r))]})};ea.displayName="ChatMessages";let ei=o.memo(ea),ec=(0,o.memo)(e=>{let{files:r=[],uploading:t=!1,uploadProgress:s=0,uploadError:l=null,onRemove:a,onRetry:i,onDrop:c,className:m="",showFileName:g=!0,showFileSize:h=!0,variant:f="default",previewSize:p="md",allowPaste:v=!0,maxFiles:y=10}=e,j=(0,o.useRef)(null),b=(0,o.useRef)(new Map),w=(0,o.useRef)(0);(0,o.useEffect)(()=>()=>{b.current.forEach(e=>{URL.revokeObjectURL(e)}),b.current.clear()},[]);let k=(0,o.useCallback)(async e=>{try{await x.Z.validateFile(e);let r={file:e,name:e.name||"file-".concat(Date.now(),".").concat(e.type.split("/")[1]),type:e.type,size:e.size},t=URL.createObjectURL(e);return b.current.set(r.name,t),r}catch(e){throw console.error("File processing error:",e),e}},[]);(0,o.useEffect)(()=>{if(!v)return;let e=async e=>{var t,n;if(!(null===(t=j.current)||void 0===t?void 0:t.contains(e.target))||r.length>=y)return;let o=null===(n=e.clipboardData)||void 0===n?void 0:n.items;if(!o)return;let s=Array.from(o).filter(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(0===s.length)return;e.preventDefault();let l=y-r.length;for(let e of s.slice(0,l)){let r=e.getAsFile();if(r)try{let e=await k(r);null==c||c(e)}catch(e){console.error("Paste handling error:",e)}}};return document.addEventListener("paste",e),()=>document.removeEventListener("paste",e)},[v,r.length,y,c,k]),(0,o.useEffect)(()=>{if(!j.current||!c)return;let e=async e=>{if(e.preventDefault(),e.stopPropagation(),w.current=0,j.current.classList.remove("drag-over"),r.length>=y)return;let t=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type);if(0===t.length)return;let n=y-r.length;for(let e of t.slice(0,n))try{let r=await k(e);c(r)}catch(e){console.error("Drop handling error:",e)}},t=e=>{e.preventDefault(),e.stopPropagation(),r.length<y&&j.current.classList.add("drag-over")},n=e=>{e.preventDefault(),e.stopPropagation(),w.current++,1===w.current&&r.length<y&&j.current.classList.add("drag-over")},o=e=>{e.preventDefault(),e.stopPropagation(),w.current--,0===w.current&&j.current.classList.remove("drag-over")},s=j.current;return s.addEventListener("drop",e),s.addEventListener("dragover",t),s.addEventListener("dragenter",n),s.addEventListener("dragleave",o),()=>{s.removeEventListener("drop",e),s.removeEventListener("dragover",t),s.removeEventListener("dragenter",n),s.removeEventListener("dragleave",o)}},[r.length,y,c,k]);let R=(0,o.useCallback)(e=>{let r={size:"compact"===f?20:24,className:"file-icon","aria-hidden":!0};return e.type.startsWith("image/")?(0,n.jsx)(T.XBm,{...r,color:"#00C853"}):e.type.startsWith("video/")?(0,n.jsx)(T.HiY,{...r,color:"#2196F3"}):e.type.startsWith("audio/")?(0,n.jsx)(T.IbZ,{...r,color:"#9C27B0"}):"application/pdf"===e.type?(0,n.jsx)(T.p5_,{...r,color:"#F44336"}):(0,n.jsx)(T.aAW,{...r,color:"#757575"})},[f]),N=(0,o.useCallback)(e=>{let r=b.current.get(e.name),t="rounded-lg overflow-hidden relative";return e.type.startsWith("image/")?(0,n.jsx)("div",{className:"".concat(t," bg-gray-100"),children:(0,n.jsx)("img",{src:r||e.url,alt:"".concat(e.name," 미리보기"),className:"w-full h-full object-cover",onError:e=>{e.target.onerror=null,e.target.src="/placeholder-image.png",e.target.alt="이미지 로드 실패"},loading:"lazy"})}):e.type.startsWith("video/")?(0,n.jsxs)("div",{className:"".concat(t," bg-gray-900"),children:[(0,n.jsxs)("video",{src:r||e.url,className:"w-full h-full object-cover",controls:"compact"!==f,controlsList:"nodownload",preload:"metadata","aria-label":"".concat(e.name," 비디오 미리보기"),children:[(0,n.jsx)("source",{src:r||e.url,type:e.type}),(0,n.jsx)("track",{kind:"captions"}),"비디오 미리보기를 지원하지 않는 브라우저입니다."]}),(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-30",children:R(e)})]}):(0,n.jsxs)("div",{className:"".concat(t," flex flex-col items-center justify-center bg-gray-50"),role:"img","aria-label":"".concat(e.name," 파일 아이콘"),children:[R(e),g&&(0,n.jsx)("span",{className:"mt-2 text-xs text-gray-600 truncate max-w-[80px]",children:e.type.split("/")[1].toUpperCase()})]})},[f,g,R]),C=(0,o.useCallback)(()=>l?(0,n.jsxs)(u.U,{color:"danger",className:"mt-2 flex items-center gap-2",children:[(0,n.jsx)(T.oC6,{className:"w-4 h-4","aria-hidden":"true"}),(0,n.jsx)("span",{className:"flex-1",children:l}),i&&(0,n.jsx)(d.z,{size:"sm",variant:"outline",onClick:i,children:"다시 시도"})]}):t?(0,n.jsxs)("div",{className:"mt-2 flex items-center gap-2 text-sm text-gray-600",children:[(0,n.jsx)(T.wh7,{className:"w-4 h-4 animate-spin","aria-hidden":"true"}),(0,n.jsxs)("span",{children:[s,"% 업로드 중..."]})]}):null,[l,t,s,i]);return 0===r.length?null:(0,n.jsxs)("div",{ref:j,className:"file-preview-scroll-container ".concat(m," ").concat(c?"cursor-pointer":""),role:"region","aria-label":"파일 미리보기",children:[(0,n.jsx)("div",{className:"file-preview-list",children:r.map((e,r)=>(0,n.jsx)("div",{className:"file-preview-item",children:(0,n.jsxs)("div",{className:"file-preview-content",children:[N(e),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[g&&(0,n.jsx)("div",{className:"text-sm font-medium truncate",title:e.name,children:e.name}),h&&(0,n.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:x.Z.formatFileSize(e.size)})]}),"readonly"!==f&&(0,n.jsx)("div",{className:"flex-shrink-0",children:!t&&a&&(0,n.jsx)(U.h,{size:"sm",variant:"outline",onClick:()=>{let r=b.current.get(e.name);r&&(URL.revokeObjectURL(r),b.current.delete(e.name)),a(e)},title:"".concat(e.name," 파일 제거"),"aria-label":"".concat(e.name," 파일 제거"),children:(0,n.jsx)(T.yNA,{className:"w-4 h-4","aria-hidden":"true"})})})]})},"".concat(e.name,"-").concat(r)))}),t?(0,n.jsx)("div",{className:"mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden",role:"progressbar","aria-valuenow":s,"aria-valuemin":"0","aria-valuemax":"100",children:(0,n.jsx)("div",{className:"h-full bg-primary transition-all duration-300 ease-in-out",style:{width:"".concat(s,"%")}})}):null,C(),r.length>=y&&(0,n.jsxs)(u.U,{color:"warning",className:"file-limit-warning",children:[(0,n.jsx)(T.oC6,{className:"w-4 h-4","aria-hidden":"true"}),(0,n.jsxs)("span",{children:["파일은 최대 ",y,"개까지만 업로드할 수 있습니다."]})]}),c&&(0,n.jsx)("div",{className:"absolute inset-0 bg-primary/10 border-2 border-primary border-dashed rounded-lg opacity-0 pointer-events-none transition-opacity drag-over:opacity-100","aria-hidden":"true",children:(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-primary font-medium",children:"파일을 여기에 놓으세요"})})})]})}),eu=e=>{let{onAction:r,className:t="",size:s="xs"}=e,l=navigator.platform.toUpperCase().indexOf("MAC")>=0,a=l?"⌘":"Ctrl",i=[{id:"bold",icon:T.hlZ,markdown:"**",tooltip:"굵게",shortcut:"".concat(a,"+B"),keyBinding:{key:"b",modifier:!0}},{id:"italic",icon:T.h32,markdown:"_",tooltip:"기울임",shortcut:"".concat(a,"+I"),keyBinding:{key:"i",modifier:!0}},{id:"inline-code",icon:T.MMM,markdown:"`",tooltip:"인라인 코드",shortcut:"".concat(a,"+`"),keyBinding:{key:"`",modifier:!0}},{id:"code-block",icon:T.VER,markdown:"```\n\n```",tooltip:"코드 블록",shortcut:"".concat(a,"+Shift+C"),keyBinding:{key:"c",modifier:!0,shift:!0}},{id:"bullet-list",icon:T.Rag,markdown:"- ",tooltip:"글머리 기호",shortcut:"".concat(a,"+U"),keyBinding:{key:"u",modifier:!0}},{id:"numbered-list",icon:T.yPu,markdown:"1. ",tooltip:"번호 매기기",shortcut:"".concat(a,"+O"),keyBinding:{key:"o",modifier:!0}},{id:"quote",icon:T.NfN,markdown:"> ",tooltip:"인용",shortcut:"".concat(a,"+Q"),keyBinding:{key:"q",modifier:!0}},{id:"heading",icon:T.R5E,markdown:"## ",tooltip:"제목",shortcut:"".concat(a,"+H"),keyBinding:{key:"h",modifier:!0}},{id:"link",icon:T.usw,markdown:"[](url)",tooltip:"링크",shortcut:"".concat(a,"+K"),keyBinding:{key:"k",modifier:!0}}],c=(0,o.useCallback)(e=>{let t=l?e.metaKey:e.ctrlKey,n=i.find(r=>{let n=r.keyBinding;return n.key===e.key.toLowerCase()&&n.modifier===t&&(!n.shift||n.shift===e.shiftKey)});n&&(e.preventDefault(),r(n.markdown))},[r,l,i]);o.useEffect(()=>(document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}),[c]);let u=e=>{let{action:t}=e,o=t.icon;return(0,n.jsx)(U.h,{variant:"ghost",size:"md",onClick:()=>r(t.markdown),"aria-label":"".concat(t.tooltip," (").concat(t.shortcut,")"),title:"".concat(t.tooltip," (").concat(t.shortcut,")"),children:(0,n.jsx)(o,{size:20})})};return(0,n.jsx)("div",{className:"markdown-toolbar ".concat(t),children:(0,n.jsx)(g.Ug,{gap:"050",role:"group","aria-label":"Markdown toolbar",children:i.map(e=>(0,n.jsx)(u,{action:e},e.id))})})},ed=(0,o.memo)(e=>{let{participants:r=[],activeIndex:t=0,onSelect:s=()=>{},onMouseEnter:l=()=>{}}=e,i=(0,o.useRef)(null),c=(0,o.useRef)([]);(0,o.useEffect)(()=>{if(!i.current||!c.current[t])return;let e=i.current,r=c.current[t],n=r.offsetTop,o=n+r.offsetHeight,s=e.scrollTop,l=s+e.offsetHeight;n<s?e.scrollTo({top:n,behavior:"smooth"}):o>l&&e.scrollTo({top:o-e.offsetHeight,behavior:"smooth"})},[t]);let u=(0,o.useCallback)(e=>{if(!e)return{};if(e.isAI){let r=(0,M.eK)(e.name);return{backgroundColor:r.backgroundColor,color:r.color,boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)"}}let r=(0,M.FV)(e.email),t=(0,M.pJ)(r);return{backgroundColor:r,color:t,boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"}},[]),d=(0,o.useCallback)(e=>e.isAI?(0,n.jsx)("span",{className:"mention-badge ai",children:"AI 어시스턴트"}):(0,n.jsx)("span",{className:"mention-badge user",title:e.email,children:e.email}),[]),m=(0,o.useCallback)(e=>e.isAI?"wayneAI"===e.name?"W":"C":e.name.charAt(0).toUpperCase(),[]),g=(0,o.useCallback)((e,r)=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),s(r))},[s]);return(null==r?void 0:r.length)?(0,n.jsx)("div",{className:"mention-dropdown",role:"listbox","aria-label":"멘션할 사용자 목록",ref:i,children:r.map((e,r)=>(0,n.jsx)("div",{ref:e=>c.current[r]=e,role:"option","aria-selected":r===t,tabIndex:0,className:"mention-item ".concat(r===t?"active":""),onClick:()=>s(e),onKeyDown:r=>g(r,e),onMouseEnter:()=>l(r),children:(0,n.jsxs)("div",{className:"mention-item-content",children:[(0,n.jsx)(a.qE.Root,{size:"sm",style:{...u(e),flexShrink:0},"aria-label":"".concat(e.name,"의 아바타"),children:(0,n.jsx)(a.qE.Fallback,{style:u(e),children:m(e)})}),(0,n.jsxs)("div",{className:"mention-info",children:[(0,n.jsx)("span",{className:"mention-name",children:e.isAI?"wayneAI"===e.name?"Wayne AI":"Consulting AI":e.name}),d(e)]})]})},e._id||"ai-".concat(e.name)))}):null}),em=(0,o.forwardRef)((e,r)=>{let{message:t="",onMessageChange:s=()=>{},onSubmit:l=()=>{},onEmojiToggle:a=()=>{},onFileSelect:i=()=>{},fileInputRef:c,disabled:u=!1,uploading:m=!1,showEmojiPicker:h=!1,showMentionList:f=!1,mentionFilter:p="",mentionIndex:v=0,getFilteredParticipants:y=()=>[],setMessage:j=()=>{},setShowEmojiPicker:b=()=>{},setShowMentionList:w=()=>{},setMentionFilter:k=()=>{},setMentionIndex:R=()=>{},room:N=null}=e,C=(0,o.useRef)(null),S=(0,o.useRef)(null),E=(0,o.useRef)(null),I=(0,o.useRef)(null),L=r||I,[M,A]=(0,o.useState)([]),[F,D]=(0,o.useState)(!1),[z,_]=(0,o.useState)(0),[P,O]=(0,o.useState)(null),[q,Z]=(0,o.useState)(!1),[W,H]=(0,o.useState)({top:0,left:0}),K=(0,o.useCallback)(async e=>{if(e)try{await x.Z.validateFile(e);let r={file:e,url:URL.createObjectURL(e),name:e.name,type:e.type,size:e.size,id:"file-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),uploadedAt:new Date().toISOString()};console.log("File preview created:",{name:r.name,type:r.type,size:r.size,hasFile:!!r.file,hasUrl:!!r.url}),A(e=>[...e,r]),O(null),null==i||i(r)}catch(e){console.error("File validation error:",e),O(e.message)}finally{(null==c?void 0:c.current)&&(c.current.value="")}},[i]),V=(0,o.useCallback)(e=>{A(r=>r.filter(r=>r.id!==e.id)),e.url&&e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url),O(null),_(0)},[]),X=(0,o.useCallback)(async e=>{e.preventDefault(),e.stopPropagation(),Z(!1);let r=Array.from(e.dataTransfer.files);if(0!==r.length)try{await K(r[0])}catch(e){console.error("File drop error:",e)}},[K]),$=(0,o.useCallback)(async e=>{if(null==e||e.preventDefault(),console.log("ChatInput handleSubmit called:",{filesCount:M.length,messageLength:t.trim().length,files:M.map(e=>({name:e.name,type:e.type,size:e.size,hasFile:!!e.file,hasUrl:!!e.url}))}),M.length>0)try{let e=M[0];if(!e)throw Error("파일 데이터가 없습니다.");if(!e.file)throw Error("원본 파일 객체가 없습니다.");console.log("Submitting file message:",{fileName:e.name,fileType:e.type,fileSize:e.size,messageContent:t.trim()}),l({type:"file",content:t.trim(),fileData:{file:e.file,name:e.name,type:e.type,size:e.size,url:e.url,id:e.id}}),j(""),A([])}catch(e){console.error("File submit error:",e),O(e.message)}else t.trim()&&(console.log("Submitting text message:",t.trim()),l({type:"text",content:t.trim()}),j(""))},[M,t,l,j]),J=(0,o.useCallback)(e=>{let r=e.target.value;j(r),s(r);let t=r.split("\n"),n=t[t.length-1].match(/@(\w*)$/);if(n){k(n[1]),w(!0),R(0);let{top:r,left:t}=e.target.getBoundingClientRect();H({top:r-200,left:t+10})}else w(!1)},[j,s,k,w,R]),Y=(0,o.useCallback)(e=>{let r=t.split("\n"),n=r[r.length-1];if(n.match(/@(\w*)$/)){let t=n.substring(0,n.lastIndexOf("@"))+"@".concat(e.name," ");r[r.length-1]=t;let o=r.join("\n");j(o),w(!1),setTimeout(()=>{if(L.current){L.current.focus();let e=o.length;L.current.setSelectionRange(e,e)}},0)}},[t,j,w,L]),G=(0,o.useCallback)(e=>{if(f){let r=y(N),t=r.length;switch(e.key){case"ArrowDown":e.preventDefault(),R(e=>e<t-1?e+1:0);break;case"ArrowUp":e.preventDefault(),R(e=>e>0?e-1:t-1);break;case"Tab":case"Enter":e.preventDefault(),t>0&&Y(r[v]);break;case"Escape":e.preventDefault(),w(!1);break;default:return}}else if("Enter"!==e.key||e.shiftKey)"Escape"===e.key&&h&&b(!1);else{if(e.nativeEvent.isComposing)return;e.preventDefault(),(t.trim()||M.length>0)&&$(e)}},[t,M,f,h,v,y,Y,$,R,w,b,N]),Q=(0,o.useCallback)(e=>{let r,n,o,s;if(!(null==L?void 0:L.current))return;let l=L.current,a=l.selectionStart,i=l.selectionEnd,c=t.substring(a,i);e.includes("\n")?(r=t.substring(0,a)+e.replace("\n\n","\n"+c+"\n")+t.substring(i),c?n=s=(o=a+e.split("\n")[0].length+1)+c.length:(o=n=a+e.indexOf("\n")+1,s=n)):e.endsWith(" ")?(r=t.substring(0,a)+e+c+t.substring(i),o=n=a+e.length+c.length,s=n):(r=t.substring(0,a)+e+c+e+t.substring(i),n=s=c?(o=a+e.length)+c.length:o=a+e.length),j(r),setTimeout(()=>{L.current&&(l.focus(),l.setSelectionRange(o,s),c&&l.setSelectionRange(n,n))},0)},[t,j,L]),ee=(0,o.useCallback)(e=>{if(!(null==L?void 0:L.current))return;let r=L.current.selectionStart||t.length;j(t.slice(0,r)+e.native+t.slice(r)),b(!1),setTimeout(()=>{if(L.current){let t=r+e.native.length;L.current.focus(),L.current.setSelectionRange(t,t)}},0)},[t,j,b,L]),er=(0,o.useCallback)(()=>{b(e=>!e)},[b]);(0,o.useEffect)(()=>{let e=e=>{var r,t;!h||(null===(r=C.current)||void 0===r?void 0:r.contains(e.target))||(null===(t=S.current)||void 0===t?void 0:t.contains(e.target))||b(!1)},r=async e=>{var r,t;if(!(null==L?void 0:null===(r=L.current)||void 0===r?void 0:r.contains(e.target)))return;let n=null===(t=e.clipboardData)||void 0===t?void 0:t.items;if(!n)return;let o=Array.from(n).find(e=>"file"===e.kind&&(e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type));if(!o)return;let s=o.getAsFile();if(s)try{await K(s),e.preventDefault()}catch(e){console.error("File paste error:",e)}};return document.addEventListener("mousedown",e),document.addEventListener("paste",r),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("paste",r),M.forEach(e=>{e.url&&e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url)})}},[h,L,M,K,b]);let et=u||F||m;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"chat-input-wrapper ".concat(q?"dragging":""),ref:E,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),Z(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),Z(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),Z(!0)},onDrop:X,children:(0,n.jsxs)("div",{className:"chat-input",children:[M.length>0&&(0,n.jsx)(ec,{files:M,uploading:F,uploadProgress:z,uploadError:P,onRemove:V,onRetry:()=>O(null),showFileName:!0,showFileSize:!0,variant:"default"}),(0,n.jsx)("div",{className:"chat-input-toolbar",children:(0,n.jsx)(eu,{onAction:Q,size:"md"})}),(0,n.jsxs)("div",{className:"chat-input-main",style:{position:"relative"},children:[(0,n.jsx)("textarea",{ref:L,value:t,onChange:J,onKeyDown:G,placeholder:q?"파일을 여기에 놓아주세요.":"메시지를 입력하세요...",disabled:et,className:"chat-input-field",rows:3,style:{width:"100%",resize:"none",border:"1px solid #e0e0e0",borderRadius:"8px",padding:"12px",fontFamily:"inherit",fontSize:"14px",lineHeight:"1.5",color:"#333"}}),(0,n.jsx)("div",{className:"chat-input-actions",children:(0,n.jsxs)(d.z,{type:"submit",size:"sm",disabled:et||!t.trim()&&0===M.length,onClick:$,className:"send-button",children:[(0,n.jsx)(T.jE$,{size:16}),"전송"]})})]}),(0,n.jsx)("div",{className:"chat-input-toolbar-bottom",children:(0,n.jsxs)(g.Ug,{spacing:"sm",children:[(0,n.jsx)(U.h,{ref:S,variant:"ghost",size:"md",onClick:er,disabled:et,"aria-label":"이모티콘",children:(0,n.jsx)(T.lME,{size:20})}),(0,n.jsx)(U.h,{variant:"ghost",size:"md",onClick:()=>{var e;return null==c?void 0:null===(e=c.current)||void 0===e?void 0:e.click()},disabled:et,"aria-label":"파일 첨부",children:(0,n.jsx)(T.Cb4,{size:20})}),(0,n.jsx)("input",{type:"file",ref:c,onChange:e=>{var r;return K(null===(r=e.target.files)||void 0===r?void 0:r[0])},style:{display:"none"},accept:"image/*,video/*,audio/*,application/pdf"})]})}),h&&(0,n.jsx)("div",{className:"emoji-picker-container",ref:C,children:(0,n.jsx)(B,{onEmojiSelect:ee})})]})}),f&&(0,n.jsx)("div",{style:{position:"fixed",top:"".concat(W.top,"px"),left:"".concat(W.left,"px"),zIndex:9999},children:(0,n.jsx)(ed,{participants:y(N),activeIndex:v,onSelect:Y,onMouseEnter:e=>R(e)})})]})});em.displayName="ChatInput";let eg=(0,h.Q)(()=>{let{room:e,messages:r,streamingMessages:t,connected:o,connectionStatus:h,messageLoadError:f,retryMessageLoad:p,currentUser:v,message:y,showEmojiPicker:x,showMentionList:j,mentionFilter:b,mentionIndex:w,filePreview:k,fileInputRef:R,messageInputRef:N,messagesEndRef:C,socketRef:S,handleMessageChange:I,handleMessageSubmit:L,handleEmojiToggle:T,setMessage:A,setShowEmojiPicker:F,setShowMentionList:D,setMentionFilter:U,setMentionIndex:z,handleKeyDown:_,removeFilePreview:P,getFilteredParticipants:B,insertMention:O,loading:q,error:Z,handleReactionAdd:W,handleReactionRemove:H,loadingMessages:K,hasMoreMessages:V,handleLoadMore:X}=E();if(q||!e)return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsx)(c.Zb.Root,{className:"chat-room-card",children:(0,n.jsx)(c.Zb.Body,{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:(0,n.jsxs)(g.xu,{style:{textAlign:"center",marginTop:"var(--vapor-space-500)"},children:[(0,n.jsx)("div",{className:"spinner-border mb-4",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("br",{}),(0,n.jsx)(i.x,{typography:"heading5",children:"채팅방 연결 중..."})]})})})});if(Z)return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsx)(c.Zb.Root,{className:"chat-room-card",children:(0,n.jsxs)(c.Zb.Body,{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[(0,n.jsx)(g.xu,{style:{marginBottom:"var(--vapor-space-400)"},children:(0,n.jsx)(u.U,{color:"danger",children:(0,n.jsxs)(g.kC,{align:"center",gap:"200",children:[(0,n.jsx)(s.Z,{className:"w-5 h-5"}),(0,n.jsx)(i.x,{children:Z||"채팅방을 불러오는데 실패했습니다."})]})})}),(0,n.jsx)(d.z,{onClick:()=>window.location.reload(),children:"다시 시도"})]})})});let $="connecting"===h?{label:"연결 중...",color:"warning"}:"connected"===h?{label:"연결됨",color:"success"}:{label:"연결 끊김",color:"danger"};return(0,n.jsx)("div",{className:"chat-container",children:(0,n.jsxs)(c.Zb.Root,{className:"chat-room-card",children:[(0,n.jsx)(c.Zb.Header,{className:"chat-room-header",children:(0,n.jsxs)(g.kC,{justify:"space-between",align:"center",children:[(0,n.jsxs)(g.kC,{align:"center",gap:"300",children:[(0,n.jsx)(i.x,{typography:"heading4",style:{fontWeight:"bold"},className:"chat-room-title",children:e.name}),(()=>{if(!(null==e?void 0:e.participants))return null;let r=e.participants,t=Math.max(0,r.length-3);return(0,n.jsxs)(g.Ug,{gap:"100",align:"center",children:[r.slice(0,3).map(e=>{let r=(0,M.FV)(e.email),t=(0,M.pJ)(r);return(0,n.jsx)(a.qE.Root,{size:"md",style:{backgroundColor:r,color:t,flexShrink:0},children:(0,n.jsx)(a.qE.Fallback,{style:{backgroundColor:r,color:t},children:e.name.charAt(0).toUpperCase()})},e._id)}),t>0&&(0,n.jsx)(a.qE.Root,{size:"md",style:{backgroundColor:"var(--vapor-color-secondary)",color:"white",flexShrink:0},children:(0,n.jsxs)(a.qE.Fallback,{style:{backgroundColor:"var(--vapor-color-secondary)",color:"white"},children:["+",t]})}),(0,n.jsxs)(i.x,{typography:"body2",className:"ms-3",children:["총 ",r.length,"명"]})]})})()]}),(0,n.jsx)(m.C,{color:"success"===$.color?"success":"warning"===$.color?"warning":"danger",children:$.label})]})}),(0,n.jsx)(c.Zb.Body,{className:"chat-room-body",children:(0,n.jsx)("div",{className:"chat-messages",children:q?(0,n.jsxs)("div",{className:"d-flex align-items-center justify-content-center p-4",children:[(0,n.jsx)("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:(0,n.jsx)("span",{className:"visually-hidden",children:"Loading..."})}),(0,n.jsx)("span",{children:"채팅방 연결 중..."})]}):Z?(0,n.jsxs)("div",{className:"d-flex flex-column align-items-center justify-content-center p-4",children:[(0,n.jsxs)(u.U,{color:"danger",className:"mb-4 d-flex align-items-center",children:[(0,n.jsx)(s.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:Z})]}),(0,n.jsx)(d.z,{onClick:()=>window.location.reload(),children:"다시 시도"})]}):"disconnected"===h?(0,n.jsx)(g.xu,{style:{margin:"var(--vapor-space-400)"},children:(0,n.jsxs)(u.U,{color:"warning",className:"d-flex align-items-center",children:[(0,n.jsx)(l.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:"연결이 끊어졌습니다. 재연결을 시도합니다..."})]})}):f?(0,n.jsxs)("div",{className:"d-flex flex-column align-items-center justify-content-center p-4",children:[(0,n.jsxs)(u.U,{color:"danger",className:"mb-4 d-flex align-items-center",children:[(0,n.jsx)(s.Z,{className:"w-5 h-5 me-2"}),(0,n.jsx)("span",{children:"메시지 로딩 중 오류가 발생했습니다."})]}),(0,n.jsx)(d.z,{onClick:p,children:"메시지 다시 로드"})]}):(0,n.jsx)(ei,{messages:r,streamingMessages:t,currentUser:v,room:e,messagesEndRef:C,onReactionAdd:W,onReactionRemove:H,loadingMessages:K,hasMoreMessages:V,onLoadMore:X,socketRef:S})})}),(0,n.jsx)(c.Zb.Footer,{className:"chat-room-footer",children:(0,n.jsx)(em,{message:y,onMessageChange:I,onSubmit:L,onEmojiToggle:T,fileInputRef:R,messageInputRef:N,filePreview:k,disabled:"connected"!==h,uploading:!1,showEmojiPicker:x,showMentionList:j,mentionFilter:b,mentionIndex:w,getFilteredParticipants:B,setMessage:A,setShowEmojiPicker:F,setShowMentionList:D,setMentionFilter:U,setMentionIndex:z,room:e,onMentionSelect:e=>{O(e),D(!1)},onFileRemove:P})})]})})})}},e=>{var r=r=>e(e.s=r);e.O(0,[834,586,658,314,510,76,849,942,888,774,179],()=>r(17722)),_N_E=e.O()}]);